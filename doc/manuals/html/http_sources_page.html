<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Source code</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('http_sources_page.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Source code </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="http_aux_hpp"></a>
http_aux.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_aux.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Auxiliary entities.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_AUX_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_AUX_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;{</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#ifdef UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keywordtype">bool</span> is_child_process(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keywordtype">bool</span> is_parent_process(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keywordtype">void</span> pid(<span class="keywordtype">int</span> v);</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keywordtype">int</span> pid(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keywordtype">int</span> check_fork(<span class="keywordtype">int</span> fork_result);</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#endif // UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keywordtype">void</span> out_str(<span class="keyword">const</span> std::string&amp; s);</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_EXCEPT_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_aux_cpp"></a>
http_aux.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_aux.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Auxiliary entities.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_aux.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;boost/thread/mutex.hpp&gt;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">using</span> boost::mutex;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">using</span> std::cout;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">using</span> std::flush;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">// aux</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"></span><span class="keywordtype">void</span> uni_http::out_str(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; s)</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;{</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;  <span class="comment">//static recursive_mutex m;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;  <span class="keyword">static</span> mutex m;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;  <span class="comment">//recursive_mutex::scoped_lock lock(m);</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  mutex::scoped_lock lock(m);</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  cout &lt;&lt; <span class="stringliteral">&quot;\r\n&quot;</span> &lt;&lt; s &lt;&lt; flush;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;}</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor">#ifdef UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="auto__sence_8hpp.html" title="Automatic platform and compiler selection.">unicomm/config/auto_sence.hpp</a>&gt;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">// aux</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keyword">namespace </span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;{</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">// global data</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keywordtype">int</span> _pid = 0;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;} <span class="comment">// unnamed namespace</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keywordtype">int</span> uni_http::check_fork(<span class="keywordtype">int</span> fork_result)</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;{</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="comment">// check fork error</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keywordflow">if</span> (fork_result &lt; 0)</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="keywordflow">throw</span> fork_error(<span class="stringliteral">&quot;Couldn&#39;t fork&quot;</span>);</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  }</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keywordflow">if</span> (fork_result &gt; 0)</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  {</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    <span class="comment">// parent</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Parent: fork succeeded; child pid = &quot;</span> &lt;&lt; fork_result)</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;    return 0;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  } </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="comment">// child (daemon) continues</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  UNICOMM_DEBUG_OUT(&quot;[http]: Child: fork succeeded&quot;)</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  return getpid();</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;}</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="keywordtype">bool</span> uni_http::is_child_process(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;{</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordflow">return</span> pid() != 0;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;}</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keywordtype">bool</span> uni_http::is_parent_process(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;{</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="keywordflow">return</span> !is_child_process();</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;}</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keywordtype">void</span> uni_http::pid(<span class="keywordtype">int</span> v)</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;{</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  _pid = v;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;}</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="keywordtype">int</span> uni_http::pid(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;{</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  <span class="keywordflow">return</span> _pid;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;}</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="preprocessor">#endif // UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor"></span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_basic_hpp"></a>
http_basic.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_basic.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Declares some http headers, response codes and so on.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_BASIC_HPP_</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_BASIC_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;map&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;{</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#ifdef UNICOMM_SSL</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> default_port(<span class="keywordtype">void</span>) { <span class="keywordflow">return</span> 443; }</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> default_port(<span class="keywordtype">void</span>) { <span class="keywordflow">return</span> 80; }</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#endif // UNICOMM_SSL</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;version(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;HTTP/1.0&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; </div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;head_body_separator(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;\r\n\r\n&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keyword">namespace </span>header</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;{</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">typedef</span> std::multimap&lt;std::string, std::string&gt; header_collection_type;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">// name: value separator</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; name_value_separator(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;:&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; separator(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;\r\n&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">// common headers</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; connection(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Connection&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; date(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Date&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">// request headers</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; accept(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Accept&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; host(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Host&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; user_agent(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;User-Agent&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; accept_language(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Accept-Language&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; accept_encoding(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Accept-Encoding&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">// reply headers</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; server(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Server&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">// entity headers</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; content_length(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Content-Length&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; content_type(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Content-Type&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; content_language(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Content-Language&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; last_modified(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;Last-Modified&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;} <span class="comment">// namespace header</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">namespace </span>status_code</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;{</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">// success </span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; ok(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;200 OK&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; created(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;201 Created&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; accepted(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;202 Accepted&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">// client error</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; bad_request(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;400 Bad Request&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; unauthorized(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;401 Unauthorized&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; forbidden(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;403 Forbidden&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; not_found(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;404 Not Found&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; method_not_allowed(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;405 Method Not Allowed&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; length_required(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;411 Length Required&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; unprocessable_entity(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;422 Unprocessable Entity&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment">// server error</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; internal_server_error(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;500 Internal Server Error&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; not_implemented(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;501 Not Implemented&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;} <span class="comment">// namespace status_code</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="keyword">namespace </span>mime_type</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;{</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="comment">// application types</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; application_zip(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;application/zip&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; application_octet_stream(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;application/octet-stream&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="comment">// image types</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; image_gif(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;image/gif&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; image_jpeg(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;image/jpeg&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; image_png(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;image/png&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">// text types</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; text_html(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;text/html&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; text_plain(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;text/plain&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; text_css(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;text/css&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> std::string&amp; text_xml(<span class="keywordtype">void</span>) { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;text/xml&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="keyword">const</span> std::string&amp; ext_to_mime(<span class="keyword">const</span> std::string&amp; ext, <span class="keyword">const</span> std::string&amp; default_mime = application_octet_stream());</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;} <span class="comment">// namespace mime_type</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="keyword">typedef</span> std::vector&lt;char&gt; buffer_type;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_BASIC_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_basic_cpp"></a>
http_basic.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_basic.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Declares some http headers, response codes and so on.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160; </div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;boost/assign.hpp&gt;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="keyword">using</span> std::multimap;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="keyword">using</span> boost::assign::map_list_of;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; uni_http::mime_type::ext_to_mime(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; ext, </div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;                                               <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; default_mime)</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;{</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;  <span class="keyword">typedef</span> multimap&lt;string, string&gt; mime_collection_type;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> mime_collection_type mime_types = </div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;    map_list_of</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;      (<span class="stringliteral">&quot;.zip&quot;</span>, application_zip())</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;      (<span class="stringliteral">&quot;.gif&quot;</span>, image_gif())</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;      (<span class="stringliteral">&quot;.jpe&quot;</span>, image_jpeg())</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;      (<span class="stringliteral">&quot;.jpg&quot;</span>, image_jpeg())</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;      (<span class="stringliteral">&quot;.jpeg&quot;</span>, image_jpeg())</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;      (<span class="stringliteral">&quot;.png&quot;</span>, image_png())</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;      (<span class="stringliteral">&quot;.htm&quot;</span>, text_html())</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;      (<span class="stringliteral">&quot;.html&quot;</span>, text_html())</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;      (<span class="stringliteral">&quot;.txt&quot;</span>, text_plain())</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;      (<span class="stringliteral">&quot;.xml&quot;</span>, text_xml())</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;      (<span class="stringliteral">&quot;.css&quot;</span>, text_css())</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    ;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  mime_collection_type::const_iterator cit = mime_types.find(ext);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="comment">// by default send reply as binary data</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keywordflow">return</span> cit == mime_types.end()? </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    (default_mime.empty()? ext: default_mime): cit-&gt;second;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;}</div>
</div><!-- fragment --><h1><a class="anchor" id="http_config_hpp"></a>
http_config.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_config.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// This is just an example shows how to use unicomm to define </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// different type of protocols based on tcp/ip. </span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// There are only few messages defined not all of HTTP.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_CONFIG_HPP_</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_CONFIG_HPP_</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="config_8hpp.html" title="Configuration storage.">unicomm/config.hpp</a>&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="client_8hpp.html" title="Client definition.">unicomm/client.hpp</a>&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;{</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; server_config(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; client_config(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_CONFIG_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_config_cpp"></a>
http_config.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_config.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// This is just an example shows how to use unicomm to define </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">// different type of protocols based on tcp/ip. </span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// There are only few messages defined not all of HTTP.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160; </div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;http_config.hpp&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;http_response.hpp&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;http_request.hpp&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;http_message_encoder.hpp&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;http_message_decoder.hpp&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="config_8hpp.html" title="Configuration storage.">unicomm/config.hpp</a>&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;boost/thread/mutex.hpp&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;boost/assign.hpp&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">using</span> std::cout;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">using</span> std::endl;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">using</span> std::flush;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">namespace </span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;{</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; common_config(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;{</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <span class="keyword">using namespace </span>unicomm;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="keyword">static</span> <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a> conf</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    (</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;      <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>()</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;        .tcp_port(uni_http::default_port())</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;        .timeouts_enabled(<span class="keyword">true</span>)</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;        .message_encoder(<a class="code" href="namespaceunicomm.html#aeb7343811ca329b13f868f7c3a44ed26" title="Default creator function, can be used with the factory.">uni_http::message_encoder::create</a>())</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;        .message_decoder(<a class="code" href="namespaceunicomm.html#aeb7343811ca329b13f868f7c3a44ed26" title="Default creator function, can be used with the factory.">uni_http::message_decoder::create</a>())</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    );</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  <span class="keywordflow">return</span> conf;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;}</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;} <span class="comment">// unnamed namespace</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; uni_http::server_config(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;{</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  <span class="keyword">using namespace </span>unicomm;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keyword">static</span> <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a> conf</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    (</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;      common_config()</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        .dispatcher_idle_tout(10)</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        .message_factory</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;          (</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;            <a class="code" href="classunicomm_1_1message__base.html#a5ca7d33017875646b37b45b904d53c08" title="Messages factory type.">message_base::factory_type</a>(&amp;unicomm::create&lt;uni_http::request&gt;)</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;          )</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;#ifdef UNICOMM_SSL</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        .ssl_server_key_password(<span class="stringliteral">&quot;test&quot;</span>)</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        .ssl_server_cert_chain_fn(<span class="stringliteral">&quot;../../../../http/ssl/server.pem&quot;</span>)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;        .ssl_server_key_fn(<span class="stringliteral">&quot;../../../../http/ssl/server.pem&quot;</span>)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;        .ssl_server_dh_fn(<span class="stringliteral">&quot;../../../../http/ssl/dh512.pem&quot;</span>)</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;#endif <span class="comment">// UNICOMM_SSL</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    );</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  <span class="keywordflow">return</span> conf;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;}</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment">// client definition</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; uni_http::client_config(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;{</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keyword">using namespace </span>unicomm;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keyword">static</span> <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a> conf</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    (</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;      common_config()</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        .<a class="code" href="structunicomm_1_1message__info.html" title="Message meta information.">message_info</a>(<a class="code" href="structunicomm_1_1message__info.html" title="Message meta information.">message_info</a>(uni_http::request::get(), <span class="keyword">true</span>, 10000))</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;        .message_factory</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;          (</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;            <a class="code" href="classunicomm_1_1message__base.html#a5ca7d33017875646b37b45b904d53c08" title="Messages factory type.">message_base::factory_type</a>(&amp;unicomm::create&lt;uni_http::response&gt;)</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;          )</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;#ifdef UNICOMM_SSL</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;        .ssl_client_verity_fn(<span class="stringliteral">&quot;../../../../http/ssl/ca.pem&quot;</span>)</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;#endif <span class="comment">// UNICOMM_SSL</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;    );</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keywordflow">return</span> conf;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;}</div>
</div><!-- fragment --><h1><a class="anchor" id="http_except_hpp"></a>
http_except.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_except.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Exceptions definition.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_EXCEPT_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_EXCEPT_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;stdexcept&gt;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;{</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">class </span>bad_request_error : <span class="keyword">public</span> std::runtime_error</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;{</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <span class="keyword">explicit</span> bad_request_error(<span class="keyword">const</span> std::string&amp; what): std::runtime_error(what) { <span class="comment">/* empty */</span> }</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;};</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">class </span>unprocessable_entity_error : <span class="keyword">public</span> std::runtime_error</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;{</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keyword">explicit</span> unprocessable_entity_error(<span class="keyword">const</span> std::string&amp; what): std::runtime_error(what) { <span class="comment">/* empty */</span> }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;};</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keyword">class </span>not_found_error : <span class="keyword">public</span> std::runtime_error</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;{</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keyword">explicit</span> not_found_error(<span class="keyword">const</span> std::string&amp; what): std::runtime_error(what) { <span class="comment">/* empty */</span> }</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;};</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">class </span>length_required_error : <span class="keyword">public</span> std::runtime_error</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;{</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;  <span class="keyword">explicit</span> length_required_error(<span class="keyword">const</span> std::string&amp; what): std::runtime_error(what) { <span class="comment">/* empty */</span> }</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;};</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="keyword">class </span>internal_server_error : <span class="keyword">public</span> std::runtime_error</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;{</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="keyword">explicit</span> internal_server_error(<span class="keyword">const</span> std::string&amp; what): std::runtime_error(what) { <span class="comment">/* empty */</span> }</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;};</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="preprocessor">#ifdef UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="keyword">class </span>fork_error : <span class="keyword">public</span> std::runtime_error</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;{</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keyword">explicit</span> fork_error(<span class="keyword">const</span> std::string&amp; what): std::runtime_error(what) { <span class="comment">/* empty */</span> }</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;};</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor">#endif // UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_EXCEPT_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_except_cpp"></a>
http_except.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_except.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Exceptions definition.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="http_message_base_hpp"></a>
http_message_base.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_message_base.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http message base class.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_MESSAGE_BASE_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_MESSAGE_BASE_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="message__base_8hpp.html" title="Message base class definition.">unicomm/message_base.hpp</a>&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;boost/lexical_cast.hpp&gt;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;{</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;header::header_collection_type parse_header(<span class="keyword">const</span> std::string&amp; header);</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">struct </span>message_base : <span class="keyword">public</span> <a class="code" href="classunicomm_1_1message__base.html" title="Unicomm message base class.">unicomm::message_base</a></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;{</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <span class="keyword">explicit</span> message_base(<span class="keyword">const</span> std::string&amp; data): </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    _data(data) </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  { </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  }</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  message_base&amp; add_header(<span class="keyword">const</span> std::string&amp; name, <span class="keyword">const</span> std::string&amp; value);</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  message_base&amp; remove_header(<span class="keyword">const</span> std::string&amp; name);</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keyword">const</span> std::string&amp; get_header(<span class="keyword">const</span> std::string&amp; name) <span class="keyword">const</span>;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keywordtype">void</span> clear_headers(<span class="keywordtype">void</span>);</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  std::string headers_str(<span class="keywordtype">void</span>) <span class="keyword">const</span>;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="keyword">const</span> std::string&amp; data(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _data; }</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  <span class="keywordtype">void</span> data(<span class="keyword">const</span> std::string&amp; s) { _data = s; }</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  std::string serialize(<span class="keywordtype">void</span>) <span class="keyword">const</span>;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="keywordtype">void</span> unserialize(<span class="keyword">const</span> std::string &amp;message);</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  <span class="keyword">virtual</span> std::string serialize_first_str(<span class="keywordtype">void</span>) <span class="keyword">const</span> = 0;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">void</span> unserialize_first_str(<span class="keyword">const</span> std::string &amp;message) = 0;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  header::header_collection_type _headers;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  std::string _data;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;};</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="keyword">typedef</span> message_base::pointer_type message_pointer_type;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_MESSAGE_BASE_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_message_base_cpp"></a>
http_message_base.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_message_base.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http message base class.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_message_base.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;smart/utils.hpp&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;boost/assert.hpp&gt;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;stdexcept&gt;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;functional&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;utility&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">using</span> std::equal_to;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">using</span> std::stringstream;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">using</span> std::runtime_error;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">using</span> std::vector;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">using</span> std::make_pair;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">// aux</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">namespace </span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">string</span>&amp; trimr(<span class="keywordtype">string</span>&amp; s) </div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;{</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  <span class="keywordflow">return</span> s.erase(s.find_last_not_of(<span class="charliteral">&#39; &#39;</span>) + 1);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;}</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">string</span>&amp; triml(<span class="keywordtype">string</span>&amp; s) </div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;{</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="keywordflow">return</span> s.erase(0, s.find_first_not_of(<span class="charliteral">&#39; &#39;</span>));</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;}</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">string</span>&amp; trim(<span class="keywordtype">string</span>&amp; s) </div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;{</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keywordflow">return</span> trimr(triml(s));</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;}</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">string</span> trim(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; s) </div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;{</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keywordtype">string</span> tmp = s;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keywordflow">return</span> trimr(triml(tmp));</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;}</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;} <span class="comment">// unnamed namespace</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;uni_http::header::header_collection_type uni_http::parse_header(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; header)</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;{</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  uni_http::header::header_collection_type parsed_header;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  string::size_type i = header.find(uni_http::header::separator());</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  smart::throw_if&lt;bad_request_error&gt;(boost::bind(</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    equal_to&lt;string::size_type&gt;(), i, string::npos), <span class="stringliteral">&quot;Invalid HTTP header format&quot;</span>);</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> first_string    = trim(header.substr(0, i));</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> header_reminder = header.substr(i + uni_http::header::separator().size());</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  <span class="comment">// store first string with empty string key</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;  parsed_header.insert(make_pair(<span class="stringliteral">&quot;&quot;</span>, first_string));</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  stringstream ss(header_reminder);</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keywordflow">do</span> </div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;    buffer_type buf(0x200);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    ss.getline(&amp;*buf.begin(), <span class="keyword">static_cast&lt;</span>std::streamsize<span class="keyword">&gt;</span>(buf.size()), ss.widen(<span class="charliteral">&#39;\r&#39;</span>));</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    ss.get();</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="keyword">const</span> <span class="keywordtype">string</span> s(&amp;*buf.begin()); </div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    i = s.find(uni_http::header::name_value_separator());</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;    smart::throw_if&lt;bad_request_error&gt;(boost::bind(</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;      equal_to&lt;string::size_type&gt;(), i, string::npos), <span class="stringliteral">&quot;Invalid HTTP header format&quot;</span>);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="keyword">const</span> uni_http::header::header_collection_type::value_type header = </div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;      make_pair(trim(s.substr(0, i)), </div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;      trim(s.substr(i + uni_http::header::name_value_separator().size())));</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    parsed_header.insert(header);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  } <span class="keywordflow">while</span> (ss);</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordflow">return</span> parsed_header;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;}</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment">// http message base </span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;uni_http::message_base&amp; uni_http::message_base::add_header(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; name, </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                                                           <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; value)</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;{</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  _headers.insert(make_pair(name, value)); <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;}</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;uni_http::message_base&amp; uni_http::message_base::remove_header(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; name)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;{</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  _headers.erase(name); <span class="keywordflow">return</span> *<span class="keyword">this</span>;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;}</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; uni_http::message_base::get_header(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; name)<span class="keyword"> const</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  header::header_collection_type::const_iterator cit = _headers.find(name);</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  smart::throw_if&lt;bad_request_error&gt;(boost::bind(</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    equal_to&lt;header::header_collection_type::const_iterator&gt;(), cit, _headers.end()), </div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="stringliteral">&quot;Header not found&quot;</span>);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keywordflow">return</span> cit-&gt;second;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;}</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keywordtype">void</span> uni_http::message_base::clear_headers(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;{</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  _headers.clear();</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;}</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="keywordtype">string</span> uni_http::message_base::headers_str(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="keywordtype">string</span> s;</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordflow">for</span> (header::header_collection_type::const_iterator cit = _headers.begin();</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    cit != _headers.end(); ++cit)</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  {</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    s += cit-&gt;first + (cit-&gt;first.empty()? <span class="stringliteral">&quot;&quot;</span>: header::name_value_separator() + <span class="stringliteral">&quot; &quot;</span>) + </div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      cit-&gt;second + header::separator();</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  }</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="keywordflow">return</span> s;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;}</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="keywordtype">string</span> uni_http::message_base::serialize(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="keyword"></span>{ </div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="keywordflow">return</span> serialize_first_str() + headers_str() + header::separator() + _data;</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;}</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;<span class="keywordtype">void</span> uni_http::message_base::unserialize(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; message)</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;{</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  _headers.clear();</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">size_t</span> i = message.find(head_body_separator());</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  smart::throw_if&lt;bad_request_error&gt;(boost::bind(</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    equal_to&lt;string::size_type&gt;(), i, string::npos), <span class="stringliteral">&quot;Invalid HTTP header format&quot;</span>);</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  _headers = parse_header(message.substr(0, i));</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  header::header_collection_type::const_iterator cit = _headers.find(<span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  BOOST_ASSERT(cit != _headers.end() &amp;&amp; <span class="stringliteral">&quot; - First string should exist&quot;</span>);</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  unserialize_first_str(cit-&gt;second);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  _data = message.substr(i + head_body_separator().size());</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;}</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="http_request_hpp"></a>
http_request.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_request.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http request message.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_REQUEST_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_REQUEST_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;http_message_base.hpp&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;{</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keyword">struct </span>request : <span class="keyword">public</span> message_base</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;{</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keyword">typedef</span> boost::shared_ptr&lt;request&gt; pointer_type;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> std::string&amp; <span class="keyword">get</span>(void) </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    { <span class="keyword">static</span> <span class="keyword">const</span> std::string s  = <span class="stringliteral">&quot;GET&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> std::string&amp; post(<span class="keywordtype">void</span>) </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;POST&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> std::string&amp; head(<span class="keywordtype">void</span>) </div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    { <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;HEAD&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="keyword">explicit</span> request(<span class="keyword">const</span> std::string&amp; request_name = <span class="stringliteral">&quot;&quot;</span>, </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;                   <span class="keyword">const</span> std::string&amp; uri = <span class="stringliteral">&quot;&quot;</span>, </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;                   <span class="keyword">const</span> std::string&amp; data = <span class="stringliteral">&quot;&quot;</span>): </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    message_base(data),</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    _name(request_name),</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    _uri(uri)</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  { </div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  }</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keyword">const</span> std::string&amp; name(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _name; }</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keyword">const</span> std::string&amp; uri(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _uri; }</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;  <span class="keywordtype">void</span> name(<span class="keyword">const</span> std::string&amp; s) { _name = s; }</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keywordtype">void</span> uri(<span class="keyword">const</span> std::string&amp; s) { _uri = s; }</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="comment">/*virtual*/</span> std::string serialize_first_str(<span class="keywordtype">void</span>) <span class="keyword">const</span>;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="comment">/*virtual*/</span> <span class="keywordtype">void</span> unserialize_first_str(<span class="keyword">const</span> std::string &amp;s);</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  std::string _name;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  std::string _uri;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;};</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">bool</span> is_get(<span class="keyword">const</span> request&amp; r) { <span class="keywordflow">return</span> r.name() == request::get(); }</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">bool</span> is_post(<span class="keyword">const</span> request&amp; r) { <span class="keywordflow">return</span> r.name() == request::post(); }</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">bool</span> is_head(<span class="keyword">const</span> request&amp; r) { <span class="keywordflow">return</span> r.name() == request::head(); }</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_REQUEST_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_request_cpp"></a>
http_request.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_request.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http request message.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_request.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;stdexcept&gt;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="keyword">using</span> std::stringstream;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">using</span> std::skipws;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// http request </span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">/*virtual*/</span> <span class="keywordtype">string</span> uni_http::request::serialize_first_str(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  <span class="keywordflow">return</span> name() + <span class="stringliteral">&quot; &quot;</span> + uri() + <span class="stringliteral">&quot; &quot;</span> + version() + header::separator();</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;}</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">/*virtual*/</span> <span class="keywordtype">void</span> uni_http::request::unserialize_first_str(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;s)</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;{</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;  stringstream ss(s);</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  ss.exceptions(stringstream::failbit | stringstream::badbit);</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keywordflow">try</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  {</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="keywordtype">string</span> ver;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;    ss &gt;&gt; skipws &gt;&gt; _name &gt;&gt; _uri &gt;&gt; ver;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;  } <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  {</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="keywordflow">throw</span> bad_request_error(<span class="keywordtype">string</span>(<span class="stringliteral">&quot;Invalid HTTP request header first string format [&quot;</span>) </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;      + e.what() + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;  }</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;}</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="http_response_hpp"></a>
http_response.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_response.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http response message.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_RESPONSE_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_RESPONSE_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;http_message_base.hpp&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;boost/shared_ptr.hpp&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;{</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">struct </span>response : <span class="keyword">public</span> message_base</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;{</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <span class="keyword">typedef</span> boost::shared_ptr&lt;response&gt; pointer_type;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <span class="keyword">explicit</span> response(<span class="keyword">const</span> std::string&amp; status_code = status_code::ok(),</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;                    <span class="keyword">const</span> std::string&amp; data = <span class="stringliteral">&quot;&quot;</span>): </div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    message_base(data),</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    _status_code(status_code)</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  { </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  }</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keyword">const</span> std::string&amp; name(<span class="keywordtype">void</span>)<span class="keyword"> const </span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keyword">    </span>{ <span class="keyword">static</span> <span class="keyword">const</span> std::string s = <span class="stringliteral">&quot;&quot;</span>; <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="keyword">const</span> std::string&amp; status_code(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _status_code; }</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  <span class="keywordtype">void</span> status_code(<span class="keyword">const</span> std::string&amp; s) { _status_code = s; }</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="comment">/*virtual*/</span> std::string serialize_first_str(<span class="keywordtype">void</span>) <span class="keyword">const</span>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="comment">/*virtual*/</span> <span class="keywordtype">void</span> unserialize_first_str(<span class="keyword">const</span> std::string &amp;s);</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  std::string _status_code;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;};</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_RESPONSE_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_response_cpp"></a>
http_response.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_response.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http response message.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_response.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;smart/utils.hpp&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;boost/assert.hpp&gt;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;functional&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="keyword">using</span> std::equal_to;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">// http response </span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">/*virtual*/</span> <span class="keywordtype">string</span> uni_http::response::serialize_first_str(<span class="keywordtype">void</span>)<span class="keyword"> const</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword"></span>{</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;  <span class="keywordflow">return</span> version() + <span class="stringliteral">&quot; &quot;</span> + status_code() + header::separator();</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;}</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">/*virtual*/</span> <span class="keywordtype">void</span> uni_http::response::unserialize_first_str(<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;s)</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;{</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  <span class="keyword">const</span> string::size_type pos = s.find_first_of(<span class="charliteral">&#39; &#39;</span>);</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  smart::throw_if&lt;bad_request_error&gt;(boost::bind(equal_to&lt;string::size_type&gt;(), </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;    pos, string::npos), <span class="stringliteral">&quot;Invalid HTTP response header first string format&quot;</span>);</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  BOOST_ASSERT(s.size() &gt;= pos + 1 &amp;&amp; </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="stringliteral">&quot; - String size can&#39;t be lesser then found position&quot;</span>);</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="comment">// version</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keywordtype">string</span> ver(s.begin(), s.begin() + pos);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  smart::throw_if&lt;bad_request_error&gt;(boost::bind(equal_to&lt;bool&gt;(), ver.empty(), </div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="keyword">true</span>), <span class="stringliteral">&quot;Invalid HTTP response header first string format [version missing]&quot;</span>);</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="comment">// response code</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  _status_code.assign(s.begin() + pos + 1, s.end());</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  smart::throw_if&lt;bad_request_error&gt;(boost::bind(equal_to&lt;bool&gt;(), </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    _status_code.empty(), <span class="keyword">true</span>), <span class="stringliteral">&quot;Invalid HTTP response header first string &quot;</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;      <span class="stringliteral">&quot;format [response code missing]&quot;</span>);</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;}</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="http_session_base_hpp"></a>
http_session_base.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_session_base.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Session base definition.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_SESSION_BASE_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_SESSION_BASE_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;http_aux.hpp&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="extended__session_8hpp.html" title="Extended session that allows to bind handlers to events.">unicomm/facade/extended_session.hpp</a>&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="comm_8hpp.html" title="Communication service definition.">unicomm/comm.hpp</a>&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;{</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; session_name(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; session)</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;{</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> std::string server = <span class="stringliteral">&quot;server&quot;</span>;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> std::string client = <span class="stringliteral">&quot;client&quot;</span>;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <span class="keywordflow">return</span> session.<a class="code" href="classunicomm_1_1session__base.html#a8cf82c1961c35cf6beb59bd5c51b4b21" title="Returns an indication that the session is on server side.">is_server</a>()? server: client;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;}</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">// In this example uni_http::session_base is only prints an information</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">// to the std::cout.</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> DerivedT, <span class="keyword">typename</span> SessionParamsT&gt;</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keyword">class </span>session_base : <span class="keyword">public</span> <a class="code" href="classunicomm_1_1extended__session.html" title="Session class which allows to map callable objects to events.">unicomm::extended_session</a>&lt;DerivedT, SessionParamsT&gt;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;{</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="keyword">typedef</span> <a class="code" href="classunicomm_1_1extended__session.html" title="Session class which allows to map callable objects to events.">unicomm::extended_session&lt;DerivedT, SessionParamsT&gt;</a> base_type;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keyword">explicit</span> session_base(<span class="keyword">const</span> SessionParamsT&amp; session_params):</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    base_type(session_params)</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  {</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="comment">// NOTE:</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    <span class="comment">// If it&#39;s necessary to close connection when it is just </span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="comment">// established throw any exception from session constructor. </span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="comment">// Connection will be closed and session won&#39;t be created. Throwing </span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;    <span class="comment">// disconnect_error from connection_handler causes session </span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">// disconnects too. Usual way to disconnect a session is to call </span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    <span class="comment">// communicator::disconnect() from any handler defined by the session.</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// It would be like (inside one of the session handlers scope): </span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="comment">// params.comm().disconnect();</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  }</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="comment">// virtual functions</span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="comment">// Override handlers in base class to out some information.</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  <span class="keywordtype">void</span> connected_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connected__params.html" title="Connected handler parameters.">unicomm::connected_params</a>&amp; params)</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    std::stringstream ss;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    ss &lt;&lt; name() &lt;&lt; <span class="stringliteral">&quot;: [&quot;</span> &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#a3e9aecebccde08dd624835ee458b46f7" title="Returns current object identifier.">id</a>() &lt;&lt; <span class="stringliteral">&quot;]: connected; local endpoint: &quot;</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;      &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#a0e6fc78c1d19433df3e4274d9443a9eb" title="Returns local endpoint of the established connection.">local_endpoint</a>() &lt;&lt; <span class="stringliteral">&quot;, remote endpoint: &quot;</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#a9ce6711b1ff9ac445c3db3ce9267b9e9" title="Returns remote endpoint that the communicator is connected to.">remote_endpoint</a>();</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    out_str(ss.str());</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;    <span class="comment">// dispatch further</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;    base_type::connected_handler(params);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  }</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="keywordtype">void</span> disconnected_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1disconnected__params.html" title="Disconnected handler parameters.">unicomm::disconnected_params</a>&amp; params)</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  {</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    std::stringstream ss;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    ss &lt;&lt; name() &lt;&lt; <span class="stringliteral">&quot;: [&quot;</span> &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#a3e9aecebccde08dd624835ee458b46f7" title="Returns current object identifier.">id</a>() &lt;&lt; <span class="stringliteral">&quot;]: disconnected; &quot;</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;      &lt;&lt; params.<a class="code" href="classunicomm_1_1disconnected__params.html#a2b7ce786a59652170db257d25d85c973" title="Returns a disconnected reason.">error_code</a>() &lt;&lt; <span class="stringliteral">&quot;; &quot;</span> &lt;&lt; params.<a class="code" href="classunicomm_1_1disconnected__params.html#a861486491dae14352b0b0d49fc23542f" title="Returns a disconnected reason string.">what</a>();</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    out_str(ss.str());</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;    <span class="comment">// dispatch further</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;    base_type::disconnected_handler(params);</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  }</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keywordtype">void</span> message_timeout_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1message__sent__params.html" title="Message sent handler parameters.">unicomm::message_timeout_params</a>&amp; params)</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  {</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;    std::stringstream ss;</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    ss &lt;&lt; name() &lt;&lt; <span class="stringliteral">&quot;: [&quot;</span> &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#a3e9aecebccde08dd624835ee458b46f7" title="Returns current object identifier.">id</a>()</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      &lt;&lt; <span class="stringliteral">&quot;]: other side didn&#39;t reply within timeout, message id: &quot;</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;      &lt;&lt; params.<a class="code" href="classunicomm_1_1message__sent__params.html#a39e3d31bfff1fdd8e072b6071d284954" title="Returns a sent message&#39;s identifier.">message_id</a>();</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;    out_str(ss.str());</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="comment">// dispatch further</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    base_type::message_timeout_handler(params);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  }</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordtype">void</span> error_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1error__params.html" title="Error handler parameters.">unicomm::error_params</a>&amp; params)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  {</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    std::stringstream ss;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    ss &lt;&lt; name() &lt;&lt; <span class="stringliteral">&quot;: [&quot;</span> &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#a3e9aecebccde08dd624835ee458b46f7" title="Returns current object identifier.">id</a>()</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;      &lt;&lt; <span class="stringliteral">&quot;]: an error occurred, error: &quot;</span> &lt;&lt; params.<a class="code" href="classunicomm_1_1error__params.html#a941ed1ac99cc26b5cd02055a854f352c" title="Returns an error description.">description</a>();</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    out_str(ss.str());</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    <span class="comment">// dispatch further</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    base_type::error_handler(params);</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  }</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="keyword">protected</span>:</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; name(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> session_name(*<span class="keyword">this</span>); }</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;};</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_SESSION_BASE_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_client_session_hpp"></a>
http_client_session.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_client_session.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Client&#39;s session definition.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_CLIENT_SESSION_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_CLIENT_SESSION_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;http_session_base.hpp&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;{</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="keyword">struct </span>client_session_params</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;{</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  <span class="keyword">explicit</span> client_session_params(</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;      <span class="keyword">const</span> unicomm::connected_signal_type::slot_type&amp; connected_handler):</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;    _connected_handler(connected_handler)</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  {</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  }</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <span class="comment">//--------------------------------------------------------------------</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  <span class="keyword">const</span> unicomm::connected_signal_type::slot_type&amp; connected_handler(<span class="keywordtype">void</span>)<span class="keyword"> const </span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="keyword">    </span>{ <span class="keywordflow">return</span> _connected_handler; }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  unicomm::connected_signal_type::slot_type _connected_handler;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;};</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">class </span>client_session : <span class="keyword">public</span> session_base&lt;client_session, client_session_params&gt;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;{</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keyword">typedef</span> uni_http::session_base&lt;client_session, client_session_params&gt; base_type;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keyword">explicit</span> client_session(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connected__params.html" title="Connected handler parameters.">unicomm::connected_params</a>&amp; params,</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;                          <span class="keyword">const</span> session_params_type&amp; session_params):</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    base_type(session_params),</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    _in_buffer(&amp;params.in_buffer())</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  {</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    add_connected_handler(session_params.connected_handler());</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    add_disconnected_handler(boost::bind(&amp;client_session::disconnected_handler_1, <span class="keyword">this</span>, _1));</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    set_message_timeout_handler(boost::bind(&amp;client_session::message_timeout_handler_1, <span class="keyword">this</span>, _1));</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  }</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keywordtype">bool</span> is_server(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="comment">// assigned handlers</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;  <span class="keywordtype">void</span> message_timeout_handler_1(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1message__sent__params.html" title="Message sent handler parameters.">unicomm::message_timeout_params</a>&amp; params);</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keywordtype">void</span> disconnected_handler_1(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1disconnected__params.html" title="Disconnected handler parameters.">unicomm::disconnected_params</a>&amp; params);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="comment">// virtual functions</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordtype">void</span> message_arrived_handler(<a class="code" href="classunicomm_1_1message__arrived__params.html" title="Message arrived handler parameters class.">unicomm::message_arrived_params</a>&amp; params);</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <a class="code" href="classunicomm_1_1comm__buffer.html" title="Communicator buffer provides thread safe operations on buffer.">unicomm::comm_buffer</a>* _in_buffer;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;};</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="keywordtype">void</span> connect_error_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connect__error__params.html" title="Connection failure parameters class.">unicomm::connect_error_params</a>&amp; params);</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_CLIENT_SESSION_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_client_session_cpp"></a>
http_client_session.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_client_session.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Client&#39;s session definition.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_client_session.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_response.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;http_aux.hpp&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="comm_8hpp.html" title="Communication service definition.">unicomm/comm.hpp</a>&gt;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="message__base_8hpp.html" title="Message base class definition.">unicomm/message_base.hpp</a>&gt;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="handler__params_8hpp.html" title="Handler parameter types definition.">unicomm/handler_params.hpp</a>&gt;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &lt;boost/assert.hpp&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;stdexcept&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">using</span> std::stringstream;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// CLIENT session</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">// assigned handlers</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keywordtype">void</span> uni_http::client_session::message_timeout_handler_1(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1message__sent__params.html" title="Message sent handler parameters.">unicomm::message_timeout_params</a>&amp; params)</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;{</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af935e7144a562f8a58269d5f823a803b" title="Brakes the connection.">disconnect</a>();</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;  <span class="comment">// another facility to disconnect</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="comment">//throw unicomm::disconnected_error(boost::system::error_code(), </span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  <span class="comment">//  &quot;Disconnected due to message timeout&quot;);</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;}</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keywordtype">void</span> uni_http::client_session::disconnected_handler_1(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1disconnected__params.html" title="Disconnected handler parameters.">unicomm::disconnected_params</a>&amp; <span class="comment">/*params*/</span>)</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;{</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  BOOST_ASSERT(_in_buffer-&gt;empty() &amp;&amp; <span class="stringliteral">&quot; - Buffer should already be empty here&quot;</span>);</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;}</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">// virtual functions</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keywordtype">void</span> uni_http::client_session::message_arrived_handler(<a class="code" href="classunicomm_1_1message__arrived__params.html" title="Message arrived handler parameters class.">unicomm::message_arrived_params</a>&amp; params)</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;{</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="comment">// use the incoming data somehow</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;  <span class="keyword">const</span> response&amp; inm = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>response&amp;<span class="keyword">&gt;</span>(params.<a class="code" href="classunicomm_1_1message__arrived__params.html#aba131b39d189b2c052444c10b982a9bf" title="Returns reference to the arrived message.">in_message</a>());</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  out_str(inm.headers_str());</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  <span class="comment">//inm.data();</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af935e7144a562f8a58269d5f823a803b" title="Brakes the connection.">disconnect</a>();</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;}</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">// connect error handler</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="keywordtype">void</span> uni_http::connect_error_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connect__error__params.html" title="Connection failure parameters class.">unicomm::connect_error_params</a>&amp; params)</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;{</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="keyword">const</span> boost::asio::ip::tcp::endpoint&amp; remote_endpoint = params.<a class="code" href="classunicomm_1_1connect__error__params.html#aae11a8af5bae8412c2c3c538d37fe49a" title="Returns remote end point that connection was attempted.">remote_endpoint</a>();</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  <span class="keyword">const</span> boost::system::error_code&amp; err                  = params.<a class="code" href="classunicomm_1_1connect__error__params.html#ada655ecf0159a8f206cb32f756fe4a11" title="Returns an error code of the connection attempt.">error_code</a>();</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  stringstream ss;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  ss &lt;&lt; <span class="stringliteral">&quot;client: connect to [&quot;</span> &lt;&lt; remote_endpoint &lt;&lt; <span class="stringliteral">&quot;] failed with error [&quot;</span> </div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    &lt;&lt; err &lt;&lt; <span class="stringliteral">&quot;; &quot;</span> &lt;&lt; err.message().c_str() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  out_str(ss.str());</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;}</div>
</div><!-- fragment --><h1><a class="anchor" id="http_server_session_hpp"></a>
http_server_session.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_server_session.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Server session object class.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_SERVER_SESSION_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_SERVER_SESSION_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;http_session_base.hpp&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;http_request.hpp&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &quot;http_response.hpp&quot;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &quot;http_message_base.hpp&quot;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;smart/timers.hpp&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;boost/filesystem.hpp&gt;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;{</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">struct </span>host_config</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;{</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  <span class="keyword">explicit</span> host_config(<span class="keyword">const</span> std::string&amp; host_name, <span class="keyword">const</span> std::string&amp; root_dir):</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    _name(host_name),</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    _root_dir(root_dir)</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  {</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  }</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <span class="keyword">const</span> std::string&amp; name(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _name; }</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keyword">const</span> std::string&amp; root_directory(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _root_dir; }</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  std::string _name;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  std::string _root_dir;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;};</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="keyword">typedef</span> std::map&lt;std::string, host_config&gt; hosts_collection_type;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">struct </span>server_session_params</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;{</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  <span class="keyword">explicit</span> server_session_params(<span class="keyword">const</span> hosts_collection_type&amp; served_hosts,</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    <span class="keyword">const</span> unicomm::connected_signal_type::slot_type&amp; connected_handler,</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;      <span class="keyword">const</span> unicomm::disconnected_signal_type::slot_type&amp; disconnected_handler):</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    _served_hosts(served_hosts),</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;    _connected_handler(connected_handler),</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;    _disconnected_handler(disconnected_handler)</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  {</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;  }</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="comment">//--------------------------------------------------------------------</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keyword">const</span> hosts_collection_type&amp; served_hosts(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _served_hosts; }</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keyword">const</span> unicomm::connected_signal_type::slot_type&amp; connected_handler(<span class="keywordtype">void</span>)<span class="keyword"> const </span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">    </span>{ <span class="keywordflow">return</span> _connected_handler; }</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keyword">const</span> unicomm::disconnected_signal_type::slot_type&amp; disconnected_handler(<span class="keywordtype">void</span>)<span class="keyword"> const </span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="keyword">    </span>{ <span class="keywordflow">return</span> _disconnected_handler; }</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  hosts_collection_type _served_hosts;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  unicomm::connected_signal_type::slot_type _connected_handler;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;  unicomm::disconnected_signal_type::slot_type _disconnected_handler;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;};</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="keyword">class </span>server_session : <span class="keyword">public</span> session_base&lt;server_session, server_session_params&gt;</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;{</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keyword">typedef</span> uni_http::session_base&lt;server_session, server_session_params&gt; base_type;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  <span class="comment">// don&#39;t need connected parameters here in this sample</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  server_session(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connected__params.html" title="Connected handler parameters.">unicomm::connected_params</a>&amp; <span class="comment">/*params*/</span>, </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;                 <span class="keyword">const</span> session_params_type&amp; session_params):</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    base_type(session_params),</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    _served_hosts(session_params.served_hosts()),</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    _timeout(boost::posix_time::seconds(30)),</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    _track_tout(false)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  {</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    add_connected_handler(session_params.connected_handler());</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    add_disconnected_handler(session_params.disconnected_handler());</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    set_message_sent_handler(boost::bind(&amp;server_session::message_sent_handler_1, <span class="keyword">this</span>, _1));</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    <span class="comment">// instead of using connected handler start track timeout here</span></div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    track_timeout();</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  }</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="keyword">struct </span>check_resource_result</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="comment">// interface</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  check_resource_result(hosts_collection_type::const_iterator host_cit,</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    boost::filesystem::path target, <span class="keywordtype">bool</span> is_dir):</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;    _host_cit(host_cit),</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;    _target(target),</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;    _is_dir(is_dir)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  {</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  }</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  hosts_collection_type::const_iterator requested_host(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _host_cit; }</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keyword">const</span> boost::filesystem::path&amp; requested_target(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _target; }</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="keywordtype">bool</span> is_directory(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _is_dir; }</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="comment">// private stuff</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  <span class="keyword">private</span>:</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    hosts_collection_type::const_iterator _host_cit;</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    boost::filesystem::path _target;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="keywordtype">bool</span> _is_dir;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  };</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="comment">// http server site protocol implementation</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;  response::pointer_type handle_get(<span class="keyword">const</span> uni_http::request&amp; inm);</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  response::pointer_type handle_get_file(<span class="keyword">const</span> check_resource_result&amp; r);</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  response::pointer_type handle_get_dir(<span class="keyword">const</span> check_resource_result&amp; r, <span class="keyword">const</span> std::string&amp; uri);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  response::pointer_type handle_head(<span class="keyword">const</span> uni_http::request&amp; inm);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  response::pointer_type handle_default(<span class="keywordtype">void</span>); <span class="comment">// default handler</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;  <span class="comment">//message_pointer_type handle_post(const uni_http::request&amp; inm);</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  response::pointer_type process_request(<span class="keyword">const</span> uni_http::request&amp; inm);</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;  check_resource_result check_resource(<span class="keyword">const</span> uni_http::request&amp; inm);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="comment">// incoming connection idle timeout</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;  <span class="keywordtype">void</span> is_track_timeout(<span class="keywordtype">bool</span> v) { _track_tout = v; }</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  <span class="keywordtype">bool</span> is_track_timeout(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _track_tout; }</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  <span class="keywordtype">bool</span> is_timeout_elapsed(<span class="keywordtype">void</span>)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> _timeout.elapsed(); }</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keywordtype">void</span> track_timeout(<span class="keywordtype">void</span>) { is_track_timeout(<span class="keyword">true</span>); smart::reset(_timeout); }</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  <span class="comment">// assigned handlers</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  <span class="keywordtype">void</span> message_sent_handler_1(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1message__sent__params.html" title="Message sent handler parameters.">unicomm::message_sent_params</a>&amp; params);</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  <span class="comment">// virtual functions</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keywordtype">void</span> message_arrived_handler(<a class="code" href="classunicomm_1_1message__arrived__params.html" title="Message arrived handler parameters class.">unicomm::message_arrived_params</a>&amp; params);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  <span class="keywordtype">void</span> error_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1error__params.html" title="Error handler parameters.">unicomm::error_params</a>&amp; params);</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  <span class="keywordtype">void</span> after_processed_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1params__base.html" title="Parameters base.">unicomm::after_processed_params</a>&amp; params);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  hosts_collection_type _served_hosts;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  smart::timeout _timeout;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="keywordtype">bool</span> _track_tout;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;};</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_SERVER_SESSION_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_server_session_cpp"></a>
http_server_session.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_server_session.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Server session object class.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_server_session.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_aux.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;http_request.hpp&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;http_response.hpp&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="comm_8hpp.html" title="Communication service definition.">unicomm/comm.hpp</a>&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;smart/debug_out.hpp&gt;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;boost/assert.hpp&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;boost/filesystem.hpp&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;boost/lexical_cast.hpp&gt;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;boost/date_time/posix_time/ptime.hpp&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#ifdef UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (push)</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (disable : 4127) // warning C4127: conditional expression is constant</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;boost/date_time/posix_time/time_formatters.hpp&gt;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor">#ifdef UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (pop)</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor">#include &lt;stdexcept&gt;</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="preprocessor">#include &lt;vector&gt;</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#include &lt;iomanip&gt;</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor">#include &lt;ctime&gt;</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="keyword">using</span> std::stringstream;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="keyword">using</span> std::ifstream;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="keyword">using</span> std::setprecision;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="keyword">using</span> std::setw;</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keyword">using</span> std::for_each;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">using</span> boost::filesystem::exists;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="keyword">using</span> boost::filesystem::path;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="keyword">using</span> boost::filesystem::file_size;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keyword">using</span> boost::filesystem::is_directory;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="keyword">using</span> boost::filesystem::directory_iterator;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="keyword">using</span> boost::filesystem::extension;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keyword">using</span> boost::filesystem::last_write_time;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="keyword">using</span> boost::lexical_cast;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="keyword">using</span> boost::posix_time::ptime;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="keyword">using</span> boost::posix_time::from_time_t;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="keyword">using</span> boost::posix_time::to_simple_string;</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="keyword">using</span> boost::uintmax_t;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">// aux</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="keyword">namespace </span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;{</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">// http logic</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;uni_http::response::pointer_type create_reply(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; reply_code, </div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;                                              <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; data = <span class="stringliteral">&quot;&quot;</span>, </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;                                              <span class="keywordtype">bool</span> add_content_length = <span class="keyword">true</span>)</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;{</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  uni_http::response::pointer_type reply(<span class="keyword">new</span> uni_http::response(reply_code, data));</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  reply-&gt;add_header(uni_http::header::server(), <span class="stringliteral">&quot;Unicomm based HTTP 1.0 server&quot;</span>);</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keyword">const</span> time_t now = time(0);</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="preprocessor">#ifdef UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (push)</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (disable : 4996)  // warning C4996: &#39;asctime&#39;: This function or variable may be unsafe. Consider using asctime_s instead. To disable deprecation, use _CRT_SECURE_NO_WARNINGS. See online help for details.</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keywordtype">string</span> s = asctime(gmtime(&amp;now));</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  BOOST_ASSERT(!s.empty() &amp;&amp; <span class="stringliteral">&quot; - Date time string could not be empty&quot;</span>);</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="comment">// remove asctime new line character if there is</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;  <span class="keywordflow">if</span> (s.at(s.size() - 1) &lt; <span class="charliteral">&#39; &#39;</span>) { s.resize(s.size() - 1); }</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;  reply-&gt;add_header(uni_http::header::date(), s);</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#ifdef UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (pop)</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keywordflow">if</span> (!data.empty() &amp;&amp; add_content_length)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  {</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="preprocessor">#ifdef UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (push)</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (disable : 4267) // warning C4267: &#39;argument&#39; : conversion from &#39;size_t&#39; to &#39;unsigned int&#39;, possible loss of data</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (disable : 4244) // warning C4244: &#39;+=&#39; : conversion from &#39;int&#39; to &#39;unsigned short&#39;, possible loss of data</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    reply-&gt;add_header(uni_http::header::content_length(), </div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;      lexical_cast&lt;string&gt;(data.size()));</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;<span class="preprocessor">#ifdef UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (pop)</span></div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // UNI_VISUAL_CPP</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;<span class="preprocessor"></span>  }</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keywordflow">return</span> reply;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;}</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">string</span> stub_html(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; text)</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;{</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  <span class="keywordflow">return</span> </div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    <span class="stringliteral">&quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD XHTML 1.0 Transitional//EN\&quot; &quot;</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="stringliteral">&quot;\&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\&quot;&gt;&quot;</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    <span class="stringliteral">&quot;&lt;html xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;&quot;</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;    <span class="stringliteral">&quot;&lt;head/&gt;&lt;body&gt;&lt;h1&gt;&quot;</span> + text + <span class="stringliteral">&quot;&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;}</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="keyword">inline</span> uni_http::response::pointer_type create_service_reply(<span class="keyword">const</span> std::string&amp; reply_code)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;{</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  uni_http::response::pointer_type r = create_reply(reply_code, stub_html(reply_code));</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;  r-&gt;add_header(uni_http::header::content_type(), uni_http::mime_type::text_html());</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keywordflow">return</span> r;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;}</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="keyword">inline</span> uni_http::response::pointer_type create_bad_request_reply(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;{</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;  <span class="keywordflow">return</span> create_service_reply(uni_http::status_code::bad_request());</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;}</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;<span class="keyword">inline</span> uni_http::response::pointer_type create_length_required_reply(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;{</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordflow">return</span> create_service_reply(uni_http::status_code::length_required());</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;}</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="keyword">inline</span> uni_http::response::pointer_type create_internal_server_error_reply(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;{</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="keywordflow">return</span> create_service_reply(uni_http::status_code::internal_server_error());</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;}</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="keyword">inline</span> uni_http::response::pointer_type create_not_implemented_reply(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;{</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  <span class="keywordflow">return</span> create_service_reply(uni_http::status_code::not_implemented());</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;}</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keyword">inline</span> uni_http::response::pointer_type create_not_found_reply(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;{</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="keywordflow">return</span> create_service_reply(uni_http::status_code::not_found());</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;}</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="keyword">inline</span> uni_http::response::pointer_type create_unprocessable_entity_reply(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;{</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keywordflow">return</span> create_service_reply(uni_http::status_code::unprocessable_entity());</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;}</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">// directory content listing</span></div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;<span class="keywordtype">string</span> dir_entry_type(<span class="keyword">const</span> path&amp; entry)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;{</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keywordflow">return</span> is_directory(entry)? <span class="stringliteral">&quot;DIR&quot;</span>: </div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    uni_http::mime_type::ext_to_mime(extension(entry), <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;}</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;stringstream&amp; out_file_size(stringstream&amp; ss, <span class="keyword">const</span> path&amp; entry)</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;{</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  uintmax_t fsz_bytes = file_size(entry);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;  <span class="keyword">const</span> uintmax_t kb  = 1024;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  <span class="keyword">const</span> uintmax_t mb  = kb * kb; </div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  <span class="keyword">const</span> uintmax_t gb  = mb * kb;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;  <span class="keyword">const</span> uintmax_t tb  = gb * kb;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordtype">double</span> fsz          = double(fsz_bytes);</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;  <span class="keywordtype">string</span> suffix       = <span class="stringliteral">&quot;bytes&quot;</span>;</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  <span class="keywordflow">if</span> (fsz_bytes &gt; tb)</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;  {</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    fsz    = fsz_bytes / double(tb);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    suffix = <span class="stringliteral">&quot;Tb&quot;</span>;</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  }</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsz_bytes &gt; gb)</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;  {</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    fsz    = fsz_bytes / double(gb);</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    suffix = <span class="stringliteral">&quot;Gb&quot;</span>;</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  }</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsz_bytes &gt; mb)</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  {</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    fsz    = fsz_bytes / double(mb);</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    suffix = <span class="stringliteral">&quot;Mb&quot;</span>;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  }</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsz_bytes &gt; kb)</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;  {</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;    fsz    = fsz_bytes / double(kb);</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    suffix = <span class="stringliteral">&quot;Kb&quot;</span>;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  } </div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  ss &lt;&lt; setprecision(3) &lt;&lt; fsz &lt;&lt; suffix;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  <span class="keywordflow">return</span> ss;</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;}</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">string</span> boost_path_workaround(<span class="keyword">const</span> path&amp; p) { <span class="keywordflow">return</span> p.string(); }</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;<span class="keyword">inline</span> <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; boost_path_workaround(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; s) { <span class="keywordflow">return</span> s; }</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;stringstream&amp; dir_listing_line(stringstream&amp; ss, </div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;                               <span class="keyword">const</span> directory_iterator::value_type&amp; item, </div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;                               <span class="keyword">const</span> path&amp; root_dir_path, </div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;                               <span class="keyword">const</span> path&amp; <span class="comment">/*sub_dir_path*/</span>)</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;{</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keyword">const</span> path&amp; entry      = item.path();</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">bool</span> is_dir      = is_directory(entry);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> file_name = boost_path_workaround(entry.filename()) + (is_dir? <span class="stringliteral">&quot;/&quot;</span>: <span class="stringliteral">&quot;&quot;</span>);</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> href      = entry.string().substr(root_dir_path.string().size());</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  ss &lt;&lt; <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;a href=\&quot;&quot;</span> &lt;&lt; href &lt;&lt; <span class="stringliteral">&quot;\&quot;&gt;&quot;</span> &lt;&lt; file_name &lt;&lt; <span class="stringliteral">&quot;&lt;/a&gt;&lt;/td&gt;&lt;td&gt;&quot;</span> </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;     &lt;&lt; to_simple_string(ptime(from_time_t(last_write_time(entry)))) &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;&lt;td class=\&quot;file_size\&quot;&gt;&quot;</span>;</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  <span class="keywordflow">if</span> (is_dir) { ss &lt;&lt; <span class="stringliteral">&quot;-&quot;</span>; } <span class="keywordflow">else</span> { out_file_size(ss, entry); }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  ss &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span> &lt;&lt; dir_entry_type(entry) &lt;&lt; <span class="stringliteral">&quot;&lt;/td&gt;&lt;/tr&gt;&quot;</span>;</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="keywordflow">return</span> ss;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;}</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;stringstream&amp; dir_listing_table(stringstream&amp; ss, <span class="keyword">const</span> path&amp; dir_path, </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;                                <span class="keyword">const</span> path&amp; root_dir_path, </div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;                                <span class="keyword">const</span> path&amp; sub_dir_path)</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;{</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  <span class="comment">// name, last modified, size, type</span></div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;  ss &lt;&lt; <span class="stringliteral">&quot;&lt;style&gt;td { padding: 1px 7px; }&quot;</span> </div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        <span class="stringliteral">&quot;.file_size { text-align: right; }&quot;</span> </div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        <span class="stringliteral">&quot;table { font: 10pt Tahoma; }&lt;/style&gt;&quot;</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        <span class="stringliteral">&quot;&lt;table&gt;&lt;tr&gt;&lt;th&gt;Name&lt;/th&gt;&lt;th&gt;Last modified&lt;/th&gt;&lt;th&gt;Size&lt;/th&gt;&lt;th&gt;Type&lt;/th&gt;&lt;/tr&gt;&quot;</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="stringliteral">&quot;&lt;tr&gt;&lt;th colspan=\&quot;4\&quot;&gt;&lt;hr/&gt;&lt;/th&gt;&lt;/tr&gt;&quot;</span>;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  <span class="comment">// parent directory link</span></div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;  ss &lt;&lt; <span class="stringliteral">&quot;&lt;tr&gt;&lt;td&gt;&lt;a href=\&quot;&quot;</span> &lt;&lt; sub_dir_path.parent_path().string() </div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    &lt;&lt; <span class="stringliteral">&quot;\&quot;&gt;.. Up&lt;/a&gt;&lt;/td&gt;&lt;td&gt;-&lt;/td&gt;&lt;td class=\&quot;file_size\&quot;&gt;-&lt;/td&gt;&lt;td&gt;DIR&lt;/td&gt;&lt;/tr&gt;&quot;</span>;</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  for_each(directory_iterator(dir_path), directory_iterator(), </div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;    boost::bind(&amp;dir_listing_line, boost::ref(ss), _1, </div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;    boost::ref(root_dir_path), boost::ref(sub_dir_path)));</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  ss &lt;&lt; <span class="stringliteral">&quot;&lt;tr&gt;&lt;th colspan=\&quot;4\&quot;&gt;&lt;hr/&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/table&gt;&lt;i&gt;Unicomm based HTTP 1.0 server&lt;/i&gt;&quot;</span>;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  <span class="keywordflow">return</span> ss;</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;}</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="keywordtype">string</span> dir_listing_html(<span class="keyword">const</span> path&amp; dir_path, <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; root_dir, </div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;                        <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; sub_dir)</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;{</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  BOOST_ASSERT(is_directory(dir_path) &amp;&amp; <span class="stringliteral">&quot; - Should be a directory&quot;</span>);</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  <span class="keywordflow">if</span> (!exists(dir_path)) </div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  {</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;    <span class="keywordflow">throw</span> uni_http::not_found_error(<span class="stringliteral">&quot;Requested resource not found [&quot;</span> + </div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;      dir_path.string() + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  }</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  stringstream ss;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  ss &lt;&lt; <span class="stringliteral">&quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD XHTML 1.0 Transitional//EN\&quot; &quot;</span></div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;     &lt;&lt; <span class="stringliteral">&quot;\&quot;http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\&quot;&gt;&quot;</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;     &lt;&lt; <span class="stringliteral">&quot;&lt;html xmlns=\&quot;http://www.w3.org/1999/xhtml\&quot;&gt;&lt;body&gt;&lt;h1&gt;Index of &#39;&quot;</span> </div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;     &lt;&lt; sub_dir &lt;&lt; <span class="stringliteral">&quot;&#39;&lt;/h1&gt;&quot;</span>;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;  dir_listing_table(ss, dir_path, path(root_dir), path(sub_dir)) &lt;&lt; <span class="stringliteral">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;</div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;  <span class="keywordflow">return</span> ss.str();</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;}</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;} <span class="comment">// unnamed namespace</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">// SERVER session</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="comment">// assigned handlers</span></div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;<span class="keywordtype">void</span> uni_http::server_session::message_sent_handler_1(</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;  <span class="keyword">const</span> <a class="code" href="classunicomm_1_1message__sent__params.html" title="Message sent handler parameters.">unicomm::message_sent_params</a>&amp; params)</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;{</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;  params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af935e7144a562f8a58269d5f823a803b" title="Brakes the connection.">disconnect</a>();</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;}</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">// virtual functions</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="keywordtype">void</span> uni_http::server_session::message_arrived_handler(</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  <a class="code" href="classunicomm_1_1message__arrived__params.html" title="Message arrived handler parameters class.">unicomm::message_arrived_params</a>&amp; params)</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;{</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;  is_track_timeout(<span class="keyword">false</span>);</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <span class="keyword">const</span> request&amp; inm = <span class="keyword">static_cast&lt;</span><span class="keyword">const </span>request&amp;<span class="keyword">&gt;</span>(params.<a class="code" href="classunicomm_1_1message__arrived__params.html#aba131b39d189b2c052444c10b982a9bf" title="Returns reference to the arrived message.">in_message</a>());</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keyword">const</span> response::pointer_type outm = process_request(inm);</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  params.<a class="code" href="classunicomm_1_1message__arrived__params.html#a6a7075b936eba262eccd564d8cdbdfa9" title="Returns pointer to outgoing reply.">out_message</a>(outm);</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  stringstream ss;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  ss &lt;&lt; name() &lt;&lt; <span class="stringliteral">&quot;: [&quot;</span> &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#a3e9aecebccde08dd624835ee458b46f7" title="Returns current object identifier.">id</a>() &lt;&lt; <span class="stringliteral">&quot;]: &lt;&lt; &quot;</span> </div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    &lt;&lt; inm.name() &lt;&lt; <span class="stringliteral">&quot; &quot;</span> &lt;&lt; inm.get_header(uni_http::header::host())</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;    &lt;&lt; inm.uri() &lt;&lt; <span class="stringliteral">&quot; &gt;&gt; &quot;</span> &lt;&lt; outm-&gt;status_code();</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;  out_str(ss.str());</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;}</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;<span class="keywordtype">void</span> uni_http::server_session::error_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1error__params.html" title="Error handler parameters.">unicomm::error_params</a>&amp; params)</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;{</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  <span class="keywordflow">try</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  {</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    <span class="keywordflow">throw</span>;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  } </div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> bad_request_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  {</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: 400 Bad request error [&quot;</span> </div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af5559344b753473337f0709c177ee584" title="Puts message into outgoing queue.">send</a>(*create_bad_request_reply());</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  }</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> length_required_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;  {</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: 411 Length required error [&quot;</span> </div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af5559344b753473337f0709c177ee584" title="Puts message into outgoing queue.">send</a>(*create_length_required_reply());</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;  }</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;  <span class="keywordflow">catch</span> (std::exception&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;  {</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: A std::exception [&quot;</span> </div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    <span class="comment">//BOOST_ASSERT(!&quot;An UNEXPECTED std::exception&quot;);</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af5559344b753473337f0709c177ee584" title="Puts message into outgoing queue.">send</a>(*create_internal_server_error_reply());</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;  }</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;  {</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    BOOST_ASSERT(!<span class="stringliteral">&quot;An UNKNOWN UNEXPECTED exception&quot;</span>);</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af5559344b753473337f0709c177ee584" title="Puts message into outgoing queue.">send</a>(*create_internal_server_error_reply());</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;  }</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;}</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;<span class="keywordtype">void</span> uni_http::server_session::after_processed_handler(</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keyword">const</span> <a class="code" href="classunicomm_1_1params__base.html" title="Parameters base.">unicomm::after_processed_params</a>&amp; params)</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;{</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  <span class="keywordflow">if</span> (is_track_timeout() &amp;&amp; is_timeout_elapsed())</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;  {</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: Client idle timeout occured&quot;</span>)</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    is_track_timeout(false);</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    params.comm().disconnect();</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  }</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;}</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;uni_http::response::pointer_type </div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;uni_http::server_session::handle_get(const uni_http::request&amp; inm)</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;{</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;  <span class="keyword">const</span> check_resource_result r = check_resource(inm);</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  BOOST_ASSERT(r.requested_host() != _served_hosts.end() &amp;&amp; <span class="stringliteral">&quot; - Invalid host&quot;</span>);</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  <span class="keywordflow">return</span> r.is_directory()? handle_get_dir(r, inm.uri()): handle_get_file(r);</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;}</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;uni_http::response::pointer_type </div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;uni_http::server_session::handle_get_file(<span class="keyword">const</span> server_session::check_resource_result&amp; r)</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;{</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  <span class="keyword">const</span> path&amp; file_path   = r.requested_target();</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> file_name  = r.requested_target().string();</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  ifstream file(file_name.c_str(), ifstream::binary);</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;  <span class="keywordflow">if</span> (!file)</div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;  {</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;    <span class="keywordflow">throw</span> internal_server_error(<span class="stringliteral">&quot;Can&#39;t handle GET request, file [&quot;</span> + file_name + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  }</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  buffer_type buf(static_cast&lt;buffer_type::size_type&gt;(file_size(file_path)));</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  file.read(&amp;*buf.begin(), <span class="keyword">static_cast&lt;</span>std::streamsize<span class="keyword">&gt;</span>(buf.size()));</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  response::pointer_type rr = create_reply(status_code::ok(), </div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="keywordtype">string</span>(buf.begin(), buf.end()));</div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> file_ext  = boost_path_workaround(file_path.extension());</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  rr-&gt;add_header(header::content_type(), mime_type::ext_to_mime(file_ext));</div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordflow">return</span> rr;</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;}</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;uni_http::response::pointer_type </div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;uni_http::server_session::handle_get_dir(<span class="keyword">const</span> server_session::check_resource_result&amp; r, </div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;                                         <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; uri)</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;{</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> buf           = dir_listing_html(r.requested_target(), </div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    r.requested_host()-&gt;second.root_directory(), uri);</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  response::pointer_type rr  = create_reply(status_code::ok(), </div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;    <span class="keywordtype">string</span>(buf.begin(), buf.end()));</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;  rr-&gt;add_header(header::content_type(), mime_type::text_html());</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;  <span class="keywordflow">return</span> rr;</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;}</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;uni_http::response::pointer_type </div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;uni_http::server_session::handle_head(<span class="keyword">const</span> uni_http::request&amp; inm)</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;{</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  check_resource(inm);</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;  <span class="keywordflow">return</span> create_reply(status_code::ok());</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;}</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;uni_http::response::pointer_type uni_http::server_session::handle_default(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;{</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;  <span class="keywordflow">return</span> create_not_implemented_reply();</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;}</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">//uni_http::message_pointer_type </span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="comment">//uni_http::server_session::handle_post(const uni_http::request&amp; inm)</span></div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="comment">//{</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;<span class="comment">//  return message_pointer_type();</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">//}</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;uni_http::response::pointer_type </div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;uni_http::server_session::process_request(<span class="keyword">const</span> uni_http::request&amp; inm)</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;{</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  response::pointer_type reply;</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="keywordflow">try</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  {</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="keywordflow">if</span> (is_get(inm))</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;    {</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;      reply = handle_get(inm);</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (is_head(inm))</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;    {</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;      reply = handle_head(inm);</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;    {</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;      reply = handle_default();</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    }</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;  } </div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> unprocessable_entity_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  {</div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: 422 Unprocessible entity error [&quot;</span> </div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;    reply = create_unprocessable_entity_reply();</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;  }</div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> not_found_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  {</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: 404 Not found error [&quot;</span> </div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    reply = create_not_found_reply();</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  }</div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> internal_server_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;  {</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: 500 Internal server error [&quot;</span> </div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;    reply = create_internal_server_error_reply();</div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  }</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  {</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: An UNEXPECTED std::exception [&quot;</span> </div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;    BOOST_ASSERT(!<span class="stringliteral">&quot;An UNEXPECTED std::exception&quot;</span>);</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;    reply = create_internal_server_error_reply();</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;  }</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;  {</div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;    BOOST_ASSERT(!<span class="stringliteral">&quot;An UNKNOWN exception!&quot;</span>);</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    reply = create_internal_server_error_reply();</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  }</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;  BOOST_ASSERT(reply != 0 &amp;&amp; <span class="stringliteral">&quot; - Reply could not be null&quot;</span>);</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;  <span class="keywordflow">return</span> reply;</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;}</div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;uni_http::server_session::check_resource_result </div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;uni_http::server_session::check_resource(<span class="keyword">const</span> uni_http::request&amp; inm)</div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;{</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; wanted_host = inm.get_header(uni_http::header::host());</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;  hosts_collection_type::const_iterator cit = _served_hosts.find(wanted_host);</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;  <span class="keywordflow">if</span> (cit == _served_hosts.end())</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  {</div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;    <span class="keywordflow">throw</span> unprocessable_entity_error(<span class="stringliteral">&quot;Requested host not found [&quot;</span> + </div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;      wanted_host + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  }</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> target_name = cit-&gt;second.root_directory() + inm.uri();</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  path target_path(target_name);</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;</div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;  <span class="keywordflow">if</span> (!exists(target_path))</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  {</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    <span class="keywordflow">throw</span> not_found_error(<span class="stringliteral">&quot;Requested resource not found [&quot;</span> + target_name + <span class="stringliteral">&quot;]&quot;</span>);</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  }</div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordtype">bool</span> is_dir = is_directory(target_path);</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  <span class="keywordflow">if</span> (is_dir)</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  {</div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;    path tmp = target_path;</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;    <span class="keywordflow">if</span> (exists(tmp /= <span class="keywordtype">string</span>(<span class="stringliteral">&quot;index.html&quot;</span>)))</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;    {</div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;      target_path = tmp;</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;      is_dir      = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;    }</div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  }</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server_session]: Resource requested [&quot;</span> </div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;    &lt;&lt; target_path.string() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  <span class="keywordflow">return</span> check_resource_result(cit, target_path, is_dir);</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;}</div>
</div><!-- fragment --><h1><a class="anchor" id="http_server_hpp"></a>
http_server.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_server.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http server class definition. It&#39;s only defined to setup sockets.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_SERVER_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_SERVER_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="server_8hpp.html" title="Server definition.">unicomm/server.hpp</a>&gt;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;{</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">class </span>server : <span class="keyword">public</span> <a class="code" href="classunicomm_1_1server.html" title="Unicomm server.">unicomm::server</a></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;{</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  <span class="keyword">explicit</span> server(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; config):</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    unicomm::server(config)</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  {</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  }</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  server(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; config,</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;         <span class="keyword">const</span> boost::asio::ip::tcp::endpoint &amp;listen_endpoint):</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    unicomm::server(config, listen_endpoint)</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;  {</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    <span class="comment">// empty</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;  }</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  ~server(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  {</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    <span class="keywordflow">try</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    {</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;      <span class="keywordflow">if</span> (started())</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;      {</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        stop();</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;      }</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    } <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;      BOOST_ASSERT(!<span class="stringliteral">&quot; - Ah ah! An unhandled exception on destructor&quot;</span>);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;    }</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  }</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keyword">using</span> <a class="code" href="classunicomm_1_1server.html#aad3bf819fc097748a34e9d05747b2398" title="Actually destroys listening socket.">unicomm::server::stop_accept</a>;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="comment">// By overriding unicomm::server::before_start() virtual function you are</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="comment">// able to setup the acceptor entity.</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="comment">//void before_start(boost::asio::ip::tcp::acceptor&amp; acceptor)</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;  <span class="comment">//{</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;  <span class="comment">//  acceptor.set_option(boost::asio::ip::tcp::acceptor::reuse_address(true));</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  <span class="comment">//}</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="comment">// By overriding unicomm::server::after_accept() virtual function you are</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;  <span class="comment">// able to setup the accepted socket.</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keywordtype">void</span> after_accept(<a class="code" href="namespaceunicomm.html#abad736b73039325da9a7212026f5f450" title="TCP Socket type.">unicomm::tcp_socket_type</a>&amp; socket);</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;};</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_SERVER_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_server_cpp"></a>
http_server.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_server.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http server class definition.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_server.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;http_aux.hpp&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;stdexcept&gt;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#ifdef UNI_UNIX</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># include &lt;sys/types.h&gt;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor"># include &lt;unistd.h&gt;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#endif // UNI_UNIX</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// http_server</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">// When using fork support. </span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">// Do not forget to implement disconnected handler. In this sample</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">// it&#39;s located in main.cpp and has same implementation for both</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">// HTTP_FORK_ON_ACCEPT defined and not defined variants.</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="keywordtype">void</span> uni_http::server::after_accept(<a class="code" href="namespaceunicomm.html#abad736b73039325da9a7212026f5f450" title="TCP Socket type.">unicomm::tcp_socket_type</a>&amp; socket) </div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;{ </div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#if defined (UNICOMM_FORK_SUPPORT) &amp;&amp; defined (HTTP_FORK_ON_ACCEPT)</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="preprocessor"># ifdef UNICOMM_SSL</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#   error &quot;Fork in couple with ssl can&#39;t be properly used in this sapmle within from uni_http::server::after_accept()&quot;</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># endif // UNICOMM_SSL</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <span class="keywordflow">try</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  {</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="keywordflow">if</span> (is_parent_process())</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;    {</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;      UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server]: Performing fork...&quot;</span>)</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;      fork_prepare();</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;      pid(check_fork(fork()));</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;      if (is_child_process()) </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;      {</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;        <span class="comment">// child process</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;        UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server]: Child: fork sweeping; pid = &quot;</span> &lt;&lt; pid())</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        fork_child();</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        UNICOMM_DEBUG_OUT(&quot;[uni_http::server]: Child: io service ready&quot;)</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        stop_accept();</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        socket.set_option(boost::asio::ip::tcp::socket::keep_alive(true));</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;      } else</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;      {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="comment">// parent process</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        UNICOMM_IFDEF_DEBUG(<span class="keyword">static</span> <span class="keywordtype">size_t</span> childs_count = 0;)</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server]: Parent: fork sweeping; childs produced: [&quot;</span> </div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;          &lt;&lt; ++childs_count &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="comment">// need no to close socket explicitly, all necessary operations are</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        <span class="comment">// performed by fork_parent()</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        fork_parent();</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;        UNICOMM_DEBUG_OUT(&quot;[uni_http::server]: Parent: io service ready&quot;)</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;      }</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    }</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;  } </div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  catch (const fork_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;  {</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server]: Fork error [&quot;</span> &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  }</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> boost::system::system_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;  {</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server]: Fatal error, can&#39;t continue [&quot;</span> </div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;    exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  }</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  {</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server]: An UNEXPECTED std::exception [&quot;</span> </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;      &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;    BOOST_ASSERT(!<span class="stringliteral">&quot;An UNEXPECTED std::exception&quot;</span>);</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;  }</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;  <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  {</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::server]: An UNEXPECTED UNKNOWN exception&quot;</span>)</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    BOOST_ASSERT(!&quot;An UNEXPECTED UNKNOWN exception&quot;);</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  }</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  socket.set_option(boost::asio::ip::tcp::socket::keep_alive(<span class="keyword">true</span>));</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor">#endif // #if defined (UNICOMM_FORK_SUPPORT) &amp;&amp; defined (HTTP_FORK_ON_ACCEPT)</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="preprocessor"></span>}</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="http_message_decoder_hpp"></a>
http_message_decoder.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_message_decoder.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http message decoder. </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_MESSAGE_DECODER_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_MESSAGE_DECODER_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="message__decoder__base_8hpp.html" title="Message decoder base class.">unicomm/message_decoder_base.hpp</a>&gt;</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;{</div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">class </span>message_decoder : <span class="keyword">public</span> <a class="code" href="classunicomm_1_1message__decoder__base.html" title="Unicomm message decoder base class.">unicomm::message_decoder_base</a></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;{</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  <span class="keyword">static</span> <a class="code" href="classunicomm_1_1message__decoder__base.html#aa72aee4b740d602228e27a3c34536559" title="Message decoder base smart pointer type.">unicomm::message_decoder_base::pointer_type</a> <a class="code" href="namespaceunicomm.html#aeb7343811ca329b13f868f7c3a44ed26" title="Default creator function, can be used with the factory.">create</a>(<span class="keywordtype">void</span>) </div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;  { </div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classunicomm_1_1message__decoder__base.html#aa72aee4b740d602228e27a3c34536559" title="Message decoder base smart pointer type.">unicomm::message_decoder_base::pointer_type</a>(<span class="keyword">new</span> message_decoder());</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  }</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;  message_decoder(<span class="keywordtype">void</span>): _length(0), _last_buf_size(0) { <span class="comment">/* emtpy */</span> }</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  <span class="keyword">virtual</span> iter_pair_type find_raw_message(<a class="code" href="classunicomm_1_1comm__buffer.html#a10debf43ea8aef87d56b411fdda0e87b" title="Actual buffer type that provides specific operations.">unicomm::comm_buffer::buffer_type</a>&amp; buffer, </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; session);</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  <span class="keyword">virtual</span> std::string&amp; decode_raw_message(std::string&amp; raw_message, </div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; session);</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keyword">virtual</span> std::string get_message_name(<span class="keyword">const</span> std::string&amp; raw_message, </div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;    <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; session);</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;  iter_pair_type finish_decode(<a class="code" href="namespaceunicomm.html#aa3ede3a0f1f6521050286f85efee560f" title="Incoming buffer type.">unicomm::in_buffer_type</a>&amp; buffer);</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  <span class="keywordtype">size_t</span> _length;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;  <span class="keywordtype">size_t</span> _last_buf_size;</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;};</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;} <span class="comment">// namespace unicomm</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_MESSAGE_DECODER_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_message_decoder_cpp"></a>
http_message_decoder.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_message_decoder.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http message decoder. </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_message_decoder.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_message_base.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">// NOTE: </span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">// if you are intended to use session object inside decoder</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">// methods you need the corresponding header to be included</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">// because of the unicomm::session_base class is just declared via </span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">// forward declaration</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &quot;http_session_base.hpp&quot;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;smart/debug_out.hpp&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;boost/lexical_cast.hpp&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;boost/assert.hpp&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;utility&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;limits&gt;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">using</span> std::make_pair;</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="keyword">using</span> std::numeric_limits;</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="keyword">using</span> boost::lexical_cast;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">// http message decoder</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<a class="code" href="classunicomm_1_1message__decoder__base.html#af096e64c9e1f8ae2b97de7329d53904e" title="Pair of income buffer iterators.">unicomm::message_decoder_base::iter_pair_type</a> </div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;uni_http::message_decoder::find_raw_message(<a class="code" href="classunicomm_1_1comm__buffer.html#a10debf43ea8aef87d56b411fdda0e87b" title="Actual buffer type that provides specific operations.">unicomm::comm_buffer::buffer_type</a>&amp; buffer, </div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;                                            <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; session)</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;{</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;  message_decoder_base::iter_pair_type bounds = make_pair(buffer.end(), buffer.end());</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;  <span class="comment">// if size is not changed assume there were no changes, so, nothing to do</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;  <span class="keywordflow">if</span> (_last_buf_size != buffer.size())</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;  {</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::message_decoder]: DECODE ENTER; Length = &quot;</span> </div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;      &lt;&lt; _length &lt;&lt; <span class="stringliteral">&quot;; Buffer size = &quot;</span> &lt;&lt; buffer.size())</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    _last_buf_size = buffer.size();</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;    <span class="keywordflow">if</span> (_length == 0) <span class="comment">// means header is not parsed yet</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    {</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">size_t</span> i = buffer.find(head_body_separator());</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;      <span class="keywordflow">if</span> (i != string::npos) </div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;      {</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        header::header_collection_type headers = parse_header(buffer.substr(0, i));</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;        <span class="comment">// get the content length </span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;        header::header_collection_type::const_iterator cit = headers.find(header::content_length());</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        <span class="comment">//_length = (cit != headers.end()? lexical_cast&lt;size_t&gt;(cit-&gt;second): 0);</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;        <span class="keywordflow">if</span> (cit != headers.end())</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;        {</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;          <span class="keywordflow">if</span> ((_length = lexical_cast&lt;size_t&gt;(cit-&gt;second)) == 0)</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;          {</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;            <span class="comment">// means message completed, unicomm will buffer.erase(bounds.first, bounds.second)</span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;            _length = i + head_body_separator().size(); <span class="comment">// add header size</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;            bounds  = finish_decode(buffer);</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;          } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;          {</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;            _length += i + head_body_separator().size(); <span class="comment">// add header size</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;            <span class="comment">// whether message completed?</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;            <span class="keywordflow">if</span> (_length &lt;= buffer.size())</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;            {</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;              bounds = finish_decode(buffer);</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;            }</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;          }</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;        {</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;          <span class="comment">// means undefined length</span></div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;          UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::message_decoder]: DECODE; Content-Length header is absent&quot;</span>)</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;          <span class="comment">// Usually, message processing is identical on both client and server sites. But</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;          <span class="comment">// sometimes it&#39;s necessary to distinct one from another. There are several</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;          <span class="comment">// way to achieve this. You may put information into the session object and use it,</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;          <span class="comment">// as done here. Also you may define two different classes derived from </span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;          <span class="comment">// unicomm::message_decoder_base (i.e. server_decoder &amp; client_decoder) and</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;          <span class="comment">// implement necessary interface the way you intend.</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;          <span class="comment">// Then you create two different configuration objects for server and client </span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;          <span class="comment">// respectively and pass corresponding decoder objects to those configurations.</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;          if (session.is_server())</div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;          { </div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="keywordflow">if</span> (i + head_body_separator().size() == buffer.size())</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;            {</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;              <span class="comment">// it seems there is no body contained by the request</span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;              _length = buffer.size();</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;              bounds  = finish_decode(buffer);</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;            {</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;              BOOST_ASSERT(buffer.size() &gt; i + head_body_separator().size());</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;              <span class="keywordflow">throw</span> length_required_error(header::content_length() + </div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;                <span class="stringliteral">&quot; header not found, but required&quot;</span>);</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;            }</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;          } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;          {</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;            <span class="comment">// client waits for the reply within timeout and disconnects if timeout occurs</span></div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;            _length = numeric_limits&lt;size_t&gt;::max();</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;          }</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        }</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      } </div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (_length &lt;= buffer.size())</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;      <span class="comment">// whether message completed?</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;      bounds = finish_decode(buffer);</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[uni_http::message_decoder]: DECODE EXIT; Length = &quot;</span> </div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      &lt;&lt; _length &lt;&lt; <span class="stringliteral">&quot;; Buffer size = &quot;</span> &lt;&lt; buffer.size())</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  }</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keywordflow">return</span> bounds;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;}</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;<span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keywordtype">string</span>&amp; uni_http::message_decoder::decode_raw_message(<span class="keywordtype">string</span>&amp; raw_message, </div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;                                                      <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; <span class="comment">/*session*/</span>)</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;{</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="keywordflow">return</span> raw_message;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;}</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;<span class="keywordtype">string</span> uni_http::message_decoder::get_message_name(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; <span class="comment">/*raw_message*/</span>, </div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;                                                   <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; <span class="comment">/*session*/</span>)</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;{</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;}</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="comment">//-----------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;<a class="code" href="classunicomm_1_1message__decoder__base.html#af096e64c9e1f8ae2b97de7329d53904e" title="Pair of income buffer iterators.">unicomm::message_decoder_base::iter_pair_type</a> </div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;uni_http::message_decoder::finish_decode(<a class="code" href="namespaceunicomm.html#aa3ede3a0f1f6521050286f85efee560f" title="Incoming buffer type.">unicomm::in_buffer_type</a>&amp; buffer)</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;{</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">size_t</span> tmp          = _length;</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  _length = _last_buf_size  = 0;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="keywordflow">return</span> make_pair(buffer.begin(), buffer.begin() + tmp);</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;}</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="http_message_encoder_hpp"></a>
http_message_encoder.hpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_message_encoder.hpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm++ - Unified Communication Protocol C++ Library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http message encoder. </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma once</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#ifndef UNI_HTTP_MESSAGE_ENCODER_HPP_</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#define UNI_HTTP_MESSAGE_ENCODER_HPP_</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="message__encoder__base_8hpp.html" title="Message encoder base class definition.">unicomm/message_encoder_base.hpp</a>&gt;</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="basic_8hpp.html" title="Basic types and constants declarations.">unicomm/basic.hpp</a>&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="keyword">namespace </span>uni_http</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;{</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="keyword">class </span>message_encoder : <span class="keyword">public</span> <a class="code" href="classunicomm_1_1message__encoder__base.html" title="Unicomm message encoder class.">unicomm::message_encoder_base</a></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;{</div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">// interface</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="keyword">public</span>:</div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;  <span class="keyword">static</span> <a class="code" href="classunicomm_1_1message__encoder__base.html#afdcdfc452f807a4728adf3b29ec9d9dc" title="Message encoder base smart pointer type.">unicomm::message_encoder_base::pointer_type</a> <a class="code" href="namespaceunicomm.html#aeb7343811ca329b13f868f7c3a44ed26" title="Default creator function, can be used with the factory.">create</a>(<span class="keywordtype">void</span>) </div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;  { </div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    <span class="keywordflow">return</span> <a class="code" href="classunicomm_1_1message__encoder__base.html#afdcdfc452f807a4728adf3b29ec9d9dc" title="Message encoder base smart pointer type.">unicomm::message_encoder_base::pointer_type</a>(<span class="keyword">new</span> message_encoder());</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;  }</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">// private stuff</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="keyword">private</span>:</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  <a class="code" href="namespaceunicomm.html#aa873a5862a912494d96807f943ac99f0" title="Outgoing buffer type.">unicomm::out_buffer_type</a>&amp; encode_raw_message(<a class="code" href="namespaceunicomm.html#aa873a5862a912494d96807f943ac99f0" title="Outgoing buffer type.">unicomm::out_buffer_type</a>&amp; buffer, </div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; session);</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;};</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;} <span class="comment">// namespace uni_http</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#endif // UNI_HTTP_MESSAGE_ENCODER_HPP_</span></div>
</div><!-- fragment --><h1><a class="anchor" id="http_message_encoder_cpp"></a>
http_message_encoder.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// http_message_encoder.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm++ - Unified Communication Protocol C++ Library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Http server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Http message encoder. </span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_message_encoder.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">// http message encoder</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<a class="code" href="namespaceunicomm.html#aa873a5862a912494d96807f943ac99f0" title="Outgoing buffer type.">unicomm::out_buffer_type</a>&amp; </div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;uni_http::message_encoder::encode_raw_message(<a class="code" href="namespaceunicomm.html#aa873a5862a912494d96807f943ac99f0" title="Outgoing buffer type.">unicomm::out_buffer_type</a>&amp; buffer, </div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;                                              <a class="code" href="classunicomm_1_1session__base.html" title="Session interface which should be implemented by user&#39;s code to receive event notifications.">unicomm::session_base</a>&amp; <span class="comment">/*session*/</span>)</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;{</div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  <span class="keywordflow">return</span> buffer;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;}</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="main_cpp"></a>
main.cpp</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// main.cpp</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Simple HTTP server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Defines the entry point for the console application.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2011, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &quot;http_client_session.hpp&quot;</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &quot;http_server_session.hpp&quot;</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;http_request.hpp&quot;</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;http_response.hpp&quot;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;http_server.hpp&quot;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;http_aux.hpp&quot;</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;http_config.hpp&quot;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;http_except.hpp&quot;</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;http_basic.hpp&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor">#include &lt;<a class="code" href="helper_8hpp.html" title="Helper routines, entities definitions and declarations.">unicomm/helper.hpp</a>&gt;</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#include &lt;smart/utils.hpp&gt;</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="preprocessor">#include &lt;boost/assert.hpp&gt;</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="preprocessor">#include &lt;boost/lexical_cast.hpp&gt;</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="preprocessor">#include &lt;boost/bind.hpp&gt;</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#include &lt;boost/assign.hpp&gt;</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor">#include &lt;boost/regex.hpp&gt;</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#include &lt;boost/system/system_error.hpp&gt;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor">#include &lt;boost/thread/thread.hpp&gt;</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#include &lt;boost/asio/ip/tcp.hpp&gt;</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor">#include &lt;boost/date_time.hpp&gt;</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (push)</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (disable : 4512)  // warning C4512: &#39;boost::program_options::options_description&#39; : assignment operator could not be generated</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="preprocessor">#include &lt;boost/program_options.hpp&gt;</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="preprocessor">#ifdef _MSC_VER</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># pragma warning (pop)</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#endif // _MSC_VER</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="preprocessor">#include &lt;string&gt;</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="preprocessor">#include &lt;stdexcept&gt;</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="preprocessor">#include &lt;functional&gt;</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="preprocessor">#include &lt;utility&gt;</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="preprocessor">#if defined (UNI_WIN)</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># include &lt;tchar.h&gt;</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="preprocessor"># include &lt;conio.h&gt;</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="preprocessor">#elif defined (UNI_UNIX)</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="preprocessor"></span><span class="preprocessor"># include &lt;fcntl.h&gt;</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="preprocessor"># include &lt;signal.h&gt;</span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="preprocessor"># include &lt;stdio.h&gt;</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="preprocessor"># include &lt;unistd.h&gt;</span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="preprocessor"># include &lt;termios.h&gt;</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="preprocessor"># include &lt;sys/ioctl.h&gt;</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="preprocessor"># include &lt;sys/time.h&gt;</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="preprocessor"># include &lt;sys/types.h&gt;</span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="preprocessor">#endif // UNI_WIN</span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="keyword">using</span> std::cout;</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="keyword">using</span> std::cin;</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="keyword">using</span> std::endl;</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="keyword">using</span> std::string;</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="keyword">using</span> std::runtime_error;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="keyword">using</span> std::equal_to;</div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="keyword">using</span> std::less;</div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="keyword">using</span> std::not_equal_to;</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="keyword">using</span> std::flush;</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="keyword">using</span> std::stringstream;</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="keyword">using</span> std::make_pair;</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="keyword">using</span> boost::regex;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="keyword">using</span> boost::cmatch;</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="keyword">using</span> boost::regex_match;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">using</span> boost::lexical_cast;</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="keyword">using</span> boost::assign::map_list_of;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="keyword">using</span> boost::asio::ip::tcp;</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="keyword">using</span> boost::this_thread::sleep;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="keyword">using</span> boost::posix_time::millisec;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="keyword">using</span> boost::posix_time::seconds;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;</div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#include &quot;main_stuff.inl&quot;</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment">// main</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#if defined (UNI_WIN)</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor"></span><span class="keywordtype">int</span> _tmain(<span class="keywordtype">int</span> argc, _TCHAR* argv[])</div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor"></span><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#endif // UNI_WIN</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;{</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordflow">try</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  {</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;    po::variables_map vm = handle_command_line(argc, argv);</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;    <span class="keywordtype">size_t</span> threads = vm[<span class="stringliteral">&quot;threads&quot;</span>].as&lt;<span class="keywordtype">size_t</span>&gt;();</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;    <span class="keywordflow">if</span> (threads &lt; 1) { threads = 1; }</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;    <span class="keywordflow">if</span> (threads &gt; 10) { threads = 10; }</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    <span class="keywordflow">if</span> (vm.count(<span class="stringliteral">&quot;url&quot;</span>) == 0)</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    {</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; host = vm[<span class="stringliteral">&quot;host&quot;</span>].as&lt;<span class="keywordtype">string</span>&gt;();</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; port = vm[<span class="stringliteral">&quot;port&quot;</span>].as&lt;<span class="keywordtype">string</span>&gt;();</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;      <span class="comment">//fixme: setter for configuration in dispatcher?</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;      <span class="keyword">const</span> boost::asio::ip::tcp::resolver::query q(host, port);</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;      <a class="code" href="classunicomm_1_1host__resolver.html" title="Host resolving helper.">unicomm::host_resolver</a> resolver = <a class="code" href="namespaceunicomm.html#a22eef6ac4a259c921fe603ebde6a0907" title="Resolves specified host name or address.">unicomm::resolve_host</a>(q);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;      uni_http::server_config().endpoint(*resolver.<a class="code" href="classunicomm_1_1host__resolver.html#a7bce861a7de105f53b2fd2382fb240d4" title="Returns iterator to the first resolved endpoint.">begin</a>());</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="preprocessor">#ifdef UNI_UNIX</span></div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;      <span class="keywordflow">if</span> (vm.count(<span class="stringliteral">&quot;daemon&quot;</span>) != 0)</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      {</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="keyword">const</span> daemonize_result_type res = become_daemon();</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        <span class="keywordflow">if</span> (!is_daemonize_error(res))</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;        {</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;          <span class="keywordflow">if</span> (is_parent_process(res))</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;          {</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            cout &lt;&lt; <span class="stringliteral">&quot;\r\n[http]: Daemon successfully started; pid = &quot;</span> &lt;&lt; res.second</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;              &lt;&lt; <span class="stringliteral">&quot;\r\n[http]: To terminate process use &#39;sudo kill -s SIGTERM &quot;</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;              &lt;&lt; res.second &lt;&lt; <span class="stringliteral">&quot;&#39;\r\n&quot;</span>;</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;            UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Parent: exit&quot;</span>)</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            exit(EXIT_SUCCESS);</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;          }</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;          UNICOMM_DEBUG_OUT(&quot;[http]: Child: demon now; pid = &quot; &lt;&lt; res.second)</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;          UNICOMM_DEBUG_OUT(&quot;[http]: Child: starting forever loop...&quot;)</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;          <span class="comment">// start server in child process</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;          start(server(), threads);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;          <span class="comment">// forever loop</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;          while (true) { sleep(seconds(1)); }</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        {</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;          cout &lt;&lt; <span class="stringliteral">&quot;\r\n[http]: An error occurred while trying to become a demon... exit&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;          UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: An error occurred while trying to become a demon... exit&quot;</span>)</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;          exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;        }</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      } else</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="preprocessor">#endif // UNI_UNIX</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;      {</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        start(server(), threads);</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;        uni_http::out_str(<span class="stringliteral">&quot;Press a key to quit&quot;</span>);</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        _getch();</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;        stop(server());</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;      }</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; url  = vm[<span class="stringliteral">&quot;url&quot;</span>].as&lt;<span class="keywordtype">string</span>&gt;();</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;      client_send_request(client(), url);</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      <span class="keywordflow">do</span></div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;      {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;        sleep(millisec(200));</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;      } <span class="keywordflow">while</span> (client().connections_count());</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    }</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  }</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; e)</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  {</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;An error occurred: &quot;</span> &lt;&lt; e.what() &lt;&lt; endl;</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  }</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  {</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;    cout &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;An error occurred: Unknown error&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    BOOST_ASSERT(!<span class="stringliteral">&quot;Unknown error&quot;</span>);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;    <span class="keywordflow">return</span> EXIT_FAILURE;</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  }</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;  <span class="keywordflow">return</span> EXIT_SUCCESS;</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;}</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div>
</div><!-- fragment --><h1><a class="anchor" id="main_stuff_inl"></a>
main_stuff.inl</h1>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">// main_stuff.inl</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">// unicomm - Unified Communication protocol C++ library.</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">// Simple HTTP server &amp; client example based on unicomm engine.</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">// Main stuff.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">// Distributed under the Boost Software License, Version 1.0.</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">// (See accompanying file LICENSE_1_0.txt or copy at</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">// http://www.boost.org/LICENSE_1_0.txt)</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">// 2012, (c) Dmitry Timoshenko.</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="keyword">namespace</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;{</div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;</div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="keyword">namespace </span>po = boost::program_options;</div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#if defined (UNI_WIN)</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor"></span><span class="keyword">typedef</span> _TCHAR char_type;</div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keywordtype">char</span> char_type;</div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="preprocessor">#endif // UNI_WIN</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">// data</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;uni_http::request _request;</div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="keywordtype">void</span> print_hello(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;{</div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="preprocessor">#ifdef UNICOMM_SSL</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">&quot;\r\nUnicomm based HTTPS server &amp; client sample&quot;</span>;</div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="preprocessor"></span>  cout &lt;&lt; <span class="stringliteral">&quot;\r\nUnicomm based HTTP server &amp; client sample&quot;</span>;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="preprocessor">#endif // UNICOMM_SSL</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="preprocessor"></span>}</div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="keywordtype">void</span> stop(<a class="code" href="classunicomm_1_1dispatcher.html" title="Unicomm communicator manager class.">unicomm::dispatcher</a>&amp; d)</div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;{</div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;  <span class="keywordflow">if</span> (d.<a class="code" href="classunicomm_1_1dispatcher.html#a15810d2dda7e1eec88eaa65ba8c64407" title="Whether processing started.">started</a>())</div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;  {</div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    d.<a class="code" href="classunicomm_1_1dispatcher.html#a823ac59627172ba536a60411a0cf2e32" title="Stops processing.">stop</a>();</div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;  }</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;}</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="keyword">template</span> &lt;<span class="keyword">typename</span> FunctionT&gt;</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="keywordtype">void</span> start_task(<span class="keyword">const</span> FunctionT&amp; f, <a class="code" href="classunicomm_1_1dispatcher.html" title="Unicomm communicator manager class.">unicomm::dispatcher</a>&amp; d, <span class="keywordtype">size_t</span> n = 1)</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;{</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="keywordflow">while</span> (n--)</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;  {</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    boost::thread(f, boost::ref(d));</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  }</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;}</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">// client</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="keywordtype">void</span> start(<a class="code" href="classunicomm_1_1client.html" title="Unicomm client.">unicomm::client</a>&amp; c, <span class="keywordtype">size_t</span> threads_num = 1);</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="keywordtype">void</span> client_send_request(<a class="code" href="classunicomm_1_1client.html" title="Unicomm client.">unicomm::client</a>&amp; c, <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; url)</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;{</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> pattern = <span class="stringliteral">&quot;((https?)://([-\\w\\.]+)+(:\\d+)?(/([\\w/_\\.]*(\\?\\S+)?)?)?)&quot;</span>;</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;  <span class="keyword">const</span> regex ex(pattern, boost::regex::mod_s);</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  cmatch matches;</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;  <span class="keywordflow">if</span> (!regex_match(url.c_str(), matches, ex))</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  {</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    <span class="keywordflow">throw</span> runtime_error(<span class="stringliteral">&quot;Target url is invalid&quot;</span>);</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;  }</div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;  <span class="comment">//smart::throw_if&lt;runtime_error&gt;(boost::bind(equal_to&lt;bool&gt;(), regex_match(url.c_str(), matches, ex), false),</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;  <span class="comment">//  &quot;Target url is invalid&quot;);</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  smart::throw_if&lt;runtime_error&gt;(boost::bind(equal_to&lt;bool&gt;(), matches[2].matched, <span class="keyword">false</span>),</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;    <span class="stringliteral">&quot;Invalid protocol type specified only http or https allowed&quot;</span>);</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;  smart::throw_if&lt;runtime_error&gt;(boost::bind(equal_to&lt;bool&gt;(), matches[3].matched, <span class="keyword">false</span>),</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    <span class="stringliteral">&quot;Host name unrecognized&quot;</span>);</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> protocol = matches[2];</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> host     = matches[3];</div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> port     = matches[4].matched? string(matches[4]):</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    lexical_cast&lt;string&gt;(uni_http::default_port());</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">string</span> uri      = string(matches[5]).empty()? string(<span class="stringliteral">&quot;/&quot;</span>): </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;    string(matches[5]);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor">#ifdef UNICOMM_SSL</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor"></span>  <span class="keyword">const</span> <span class="keywordtype">string</span> used_proto = <span class="stringliteral">&quot;https&quot;</span>;</div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span>* err_message = <span class="stringliteral">&quot;HTTP is not accessible in current build. &quot;</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;                            <span class="stringliteral">&quot;To exclude SSL remove UNICOMM_SSL macro.&quot;</span>;</div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor"></span>  <span class="keyword">const</span> <span class="keywordtype">string</span> used_proto = <span class="stringliteral">&quot;http&quot;</span>;</div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;  <span class="keyword">const</span> <span class="keywordtype">char</span>* err_message = <span class="stringliteral">&quot;HTTPS is not accessible in current build. &quot;</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;                            <span class="stringliteral">&quot;To make it to be available define UNICOMM_SSL macro.&quot;</span>;</div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor">#endif // UNICOMM_SSL</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;  smart::throw_if&lt;runtime_error&gt;(boost::bind(</div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;    not_equal_to&lt;string&gt;(), used_proto, protocol), err_message);</div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="keyword">const</span> tcp::resolver::query q(host, port);</div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <a class="code" href="classunicomm_1_1host__resolver.html" title="Host resolving helper.">unicomm::host_resolver</a> resolver = <a class="code" href="namespaceunicomm.html#a22eef6ac4a259c921fe603ebde6a0907" title="Resolves specified host name or address.">unicomm::resolve_host</a>(q);</div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  _request.name(uni_http::request::get());</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  _request.uri(uri);</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  _request.clear_headers();</div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  _request</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    .add_header(uni_http::header::user_agent(), <span class="stringliteral">&quot;Unicomm based HTTP 1.0 client&quot;</span>)</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;    .add_header(uni_http::header::accept(), uni_http::mime_type::text_html())</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;    .add_header(uni_http::header::host(), host)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;    .add_header(uni_http::header::accept_language(), <span class="stringliteral">&quot;ru&quot;</span>)</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    .add_header(uni_http::header::accept_encoding(), <span class="stringliteral">&quot;&quot;</span>)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  ;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  c.<a class="code" href="classunicomm_1_1client.html#aac5c26bb04508204d4bd41e83d7ce4ea" title="Request to connect using endpoint which is set on constructor or previous connect call...">connect</a>(tcp::endpoint(*resolver.<a class="code" href="classunicomm_1_1host__resolver.html#a7bce861a7de105f53b2fd2382fb240d4" title="Returns iterator to the first resolved endpoint.">begin</a>()));</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  start(c);</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;}</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">// client handlers</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;<span class="comment">// Those show how to add handlers instead of overriding</span></div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;<span class="comment">// unicomm::session_base virtual members. You are enabled to map</span></div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;<span class="comment">// arbitrary number of handlers to connected and disconnected events.</span></div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;<span class="comment">// Other events provide only one extra handler to be mapped.</span></div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;<span class="comment">// If you need a sequence of handlers to be mapped to other events</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;<span class="comment">// use boost signals to implement this.</span></div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;<span class="keywordtype">void</span> client_connected_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connected__params.html" title="Connected handler parameters.">unicomm::connected_params</a>&amp; params)</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;{</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#af5559344b753473337f0709c177ee584" title="Puts message into outgoing queue.">send</a>(_request);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;}</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;<span class="comment">// client</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;<a class="code" href="classunicomm_1_1client.html" title="Unicomm client.">unicomm::client</a>&amp; client(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;{</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="comment">// initialize client&#39;s configuration</span></div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; client_config = uni_http::client_config()</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    .<a class="code" href="classunicomm_1_1config.html#abe34031112411b5e67bc3fc122a576ea" title="Returns session factory object.">session_factory</a>(boost::bind(&amp;<a class="code" href="namespaceunicomm.html#aeb7343811ca329b13f868f7c3a44ed26" title="Default creator function, can be used with the factory.">uni_http::client_session::create</a>, _1,</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;      uni_http::client_session_params(&amp;client_connected_handler)));</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <span class="comment">// create client and assign a connection error handler</span></div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  <span class="comment">// connection error handler is an exception to the rules</span></div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  <span class="comment">// this handler is not included to the session due to session object</span></div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="comment">// is not created to the moment when connection error occurs.</span></div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="comment">// this handler is only called if client::connect() invoked and connect failed,</span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  <span class="comment">// so in such a case there is no session object exists</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;  <span class="comment">// create client</span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <span class="keyword">static</span> <a class="code" href="classunicomm_1_1client.html" title="Unicomm client.">unicomm::client</a> client(client_config, &amp;uni_http::connect_error_handler);</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="keywordflow">return</span> client;</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;}</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="keywordtype">void</span> client_task(<a class="code" href="classunicomm_1_1dispatcher.html" title="Unicomm communicator manager class.">unicomm::dispatcher</a>&amp; c)</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;{</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;  c.<a class="code" href="classunicomm_1_1dispatcher.html#a52ea99895975a2019246877bae490dac" title="Main dispatcher&#39;s loop.">run</a>();</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;}</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keywordtype">void</span> start(<a class="code" href="classunicomm_1_1client.html" title="Unicomm client.">unicomm::client</a>&amp; c, <span class="keywordtype">size_t</span> threads_num)</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;{</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  <span class="keywordflow">if</span> (!c.<a class="code" href="classunicomm_1_1dispatcher.html#a15810d2dda7e1eec88eaa65ba8c64407" title="Whether processing started.">started</a>())</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;  {</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    c.<a class="code" href="classunicomm_1_1dispatcher.html#a562afa6317184a43604ce5f3065b0fb4" title="Initializes the dispatcher.">reset</a>();</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  }</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="comment">//c.connect();</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  start_task(&amp;client_task, c, threads_num);</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  uni_http::out_str(<span class="stringliteral">&quot;client&gt; started&quot;</span>);</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;}</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment">// server</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;<span class="comment">// Performing fork only from within parent process listening the port for</span></div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;<span class="comment">// incoming connections. Uncomment second part of the statement</span></div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;<span class="comment">// if you wish to fork process only if current connections number exceeds the</span></div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;<span class="comment">// limit. If concurrent connections number is lesser than ten they will be</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;<span class="comment">// served by parent process itself, but if the limit exceeded</span></div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;<span class="comment">// process will fork and give all the connections to the child process.</span></div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;<span class="comment">// Please note connections count may take any value greater than or equal one.</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">// While the statement is commented the limit is equal to one.</span></div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">// The statement implicit statement in this case looks like</span></div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">// params.comm().owner().connections_count() &gt; 0 due to</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;<span class="comment">// connected handler invoked only if one or more incoming connections</span></div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="comment">// accepted on current iteration.</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;<span class="comment">//</span></div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;<span class="comment">// To strictly have one served connection per process implement</span></div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;<span class="comment">// fork on unicomm::server::after_accept(). On how it could be done please</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;<span class="comment">// take a look at uni_http::server::after_accept().</span></div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="comment">// Define HTTP_FORK_ON_ACCEPT to make this code to be compiled.</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;<span class="comment">// Do not forget to clear unicomm/out/stuff before start building</span></div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="comment">// with new define.</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;<span class="keywordtype">void</span> actual_server_connected_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connected__params.html" title="Connected handler parameters.">unicomm::connected_params</a>&amp; params)</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;{</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="preprocessor">#if defined (UNICOMM_FORK_SUPPORT) &amp;&amp; !defined (HTTP_FORK_ON_ACCEPT)</span></div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keywordflow">try</span></div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  {</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    <span class="keywordflow">if</span> (uni_http::is_parent_process() <span class="comment">/*&amp;&amp; params.comm().owner().connections_count() &gt; 9*/</span>)</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;    {</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;      UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Performing fork...&quot;</span>)</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;      params.comm().fork_prepare();</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      uni_http::pid(uni_http::check_fork(fork()));</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;      if (uni_http::is_child_process())</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;      {</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;        <span class="comment">// child process</span></div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Child: fork sweeping; pid = &quot;</span> &lt;&lt; uni_http::pid())</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        params.comm().fork_child();</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        UNICOMM_DEBUG_OUT(&quot;[http]: Child: io service ready&quot;)</div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;        static_cast&lt;uni_http::server&amp;&gt;(params.comm().owner()).stop_accept();</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;      } else</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;      {</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        <span class="comment">// parent process</span></div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        UNICOMM_IFDEF_DEBUG(<span class="keyword">static</span> <span class="keywordtype">size_t</span> childs_count = 0;)</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Parent: fork sweeping; childs produced: [&quot;</span> </div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;          &lt;&lt; ++childs_count &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        params.comm().fork_parent();</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        UNICOMM_DEBUG_OUT(&quot;[http]: Parent: io service ready&quot;)</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      }</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;    }</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  }</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  catch (const uni_http::fork_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  {</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Fork error [&quot;</span> &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  }</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> boost::system::system_error&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;  {</div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Fatal error, can&#39;t continue [&quot;</span> &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    exit(EXIT_FAILURE);</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  }</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="keywordflow">catch</span> (<span class="keyword">const</span> std::exception&amp; UNICOMM_IFDEF_DEBUG(e))</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  {</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: An UNEXPECTED std::exception [&quot;</span> &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    BOOST_ASSERT(!<span class="stringliteral">&quot;An UNEXPECTED std::exception&quot;</span>);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  }</div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;  {</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: An UNEXPECTED UNKNOWN exception&quot;</span>)</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    BOOST_ASSERT(!&quot;An UNEXPECTED UNKNOWN exception&quot;);</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;  }</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="preprocessor">#elif defined (UNI_VISUAL_CPP)</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  params; <span class="comment">// avoid unreference parameter warning</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="preprocessor">#endif // UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="preprocessor"></span>}</div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;<span class="keywordtype">void</span> actual_server_disconnected_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1disconnected__params.html" title="Disconnected handler parameters.">unicomm::disconnected_params</a>&amp; params)</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;{</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="preprocessor">#if defined (UNICOMM_FORK_SUPPORT)</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  <span class="keywordflow">if</span> (uni_http::is_child_process() &amp;&amp; (params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#ad37338c248960d5895db4eb35e2d0ce4" title="Returns a reference to the communicator object&#39;s owner.">owner</a>().<a class="code" href="classunicomm_1_1dispatcher.html#ab8c80d6f340807c3091a4a0fd5dd291b" title="Returns current connections count.">connections_count</a>() == 1))</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  {</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Child: exit&quot;</span>)</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    exit(EXIT_SUCCESS);</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;  }</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">#elif defined (UNI_VISUAL_CPP)</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  params; <span class="comment">// avoid unreference parameter warning</span></div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;<span class="preprocessor">#endif // UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;<span class="preprocessor"></span>}</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="keywordtype">void</span> server_connected_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1connected__params.html" title="Connected handler parameters.">unicomm::connected_params</a>&amp; params)</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;{</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: CONNECTED; Connections count = &quot;</span> </div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;    &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#ad37338c248960d5895db4eb35e2d0ce4" title="Returns a reference to the communicator object&#39;s owner.">owner</a>().<a class="code" href="classunicomm_1_1dispatcher.html#ab8c80d6f340807c3091a4a0fd5dd291b" title="Returns current connections count.">connections_count</a>())</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  actual_server_connected_handler(params);</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;}</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keywordtype">void</span> server_disconnected_handler(<span class="keyword">const</span> <a class="code" href="classunicomm_1_1disconnected__params.html" title="Disconnected handler parameters.">unicomm::disconnected_params</a>&amp; params)</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;{</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;  UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: DISCONNECTED; Connections count = &quot;</span> </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;    &lt;&lt; params.<a class="code" href="classunicomm_1_1params__base.html#af45141bb3d78dc963d19a6c8151ac716" title="Returns an object responsible for communication.">comm</a>().<a class="code" href="classunicomm_1_1communicator.html#ad37338c248960d5895db4eb35e2d0ce4" title="Returns a reference to the communicator object&#39;s owner.">owner</a>().<a class="code" href="classunicomm_1_1dispatcher.html#ab8c80d6f340807c3091a4a0fd5dd291b" title="Returns current connections count.">connections_count</a>())</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  actual_server_disconnected_handler(params);</div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;}</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">// server definition</span></div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;uni_http::server&amp; server(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;{</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;  <span class="comment">// setup extra parameters before use configuration</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="classunicomm_1_1config.html" title="Unicomm configuration storage class.">unicomm::config</a>&amp; server_config = uni_http::server_config().<a class="code" href="classunicomm_1_1config.html#abe34031112411b5e67bc3fc122a576ea" title="Returns session factory object.">session_factory</a></div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;    (</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;      boost::bind</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        (</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;          &amp;<a class="code" href="namespaceunicomm.html#aeb7343811ca329b13f868f7c3a44ed26" title="Default creator function, can be used with the factory.">uni_http::server_session::create</a>, _1,</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;          uni_http::server_session_params</div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;            (</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;              map_list_of</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;                (<span class="stringliteral">&quot;localhost&quot;</span>, uni_http::host_config(</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;                  <span class="stringliteral">&quot;localhost&quot;</span>, <span class="stringliteral">&quot;../../../../http/www/localhost&quot;</span>))</div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;                (<span class="stringliteral">&quot;bora-bora&quot;</span>, uni_http::host_config(</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;                  <span class="stringliteral">&quot;bora-bora&quot;</span>, <span class="stringliteral">&quot;../../../../http/www/bora-bora&quot;</span>)),</div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;              &amp;server_connected_handler,</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;              &amp;server_disconnected_handler</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;            )</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;        )</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;    )</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;  ;</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;  <span class="comment">// create server</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;  <span class="keyword">static</span> uni_http::server server(server_config);</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  <span class="keywordflow">return</span> server;</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;}</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;po::variables_map handle_command_line(<span class="keywordtype">int</span> argc, char_type* argv[])</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;{</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  po::options_description desc(<span class="stringliteral">&quot;Options&quot;</span>);</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;  desc.add_options()</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;    (<span class="stringliteral">&quot;help&quot;</span>, <span class="stringliteral">&quot;Show this screen&quot;</span>)</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    (<span class="stringliteral">&quot;host&quot;</span>, po::value&lt;string&gt;()-&gt;default_value(<span class="stringliteral">&quot;0.0.0.0&quot;</span>),</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;      <span class="stringliteral">&quot;Ip-address or host name to be listened by the server&quot;</span>)</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    (<span class="stringliteral">&quot;port&quot;</span>, po::value&lt;string&gt;()-&gt;default_value(</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      lexical_cast&lt;string&gt;(uni_http::default_port())),</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;      <span class="stringliteral">&quot;TCP port to be listened by the server&quot;</span>)</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    (<span class="stringliteral">&quot;url&quot;</span>, po::value&lt;string&gt;(), <span class="stringliteral">&quot;Run as client and connect to the url. &quot;</span></div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;      <span class="stringliteral">&quot;If omited runs as server&quot;</span>)</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;    (<span class="stringliteral">&quot;threads&quot;</span>, po::value&lt;size_t&gt;()-&gt;default_value(1), </div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;      <span class="stringliteral">&quot;Threads to run server or client task [1, 10]&quot;</span>)</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;#<span class="keywordflow">if</span> defined (UNI_LINUX)</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    (</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;      <span class="stringliteral">&quot;daemon&quot;</span>, <span class="stringliteral">&quot;Start as daemon. Only matters under Linux like systems &quot;</span></div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;      <span class="stringliteral">&quot;and if server option specified&quot;</span></div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    )</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;#endif <span class="comment">// UNI_LINUX</span></div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    <span class="comment">// fixme: add daemon &amp; fork support</span></div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    ;</div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;  po::variables_map vm;</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  <span class="keywordflow">try</span></div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;  {</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    po::store(po::parse_command_line(argc, argv, desc), vm);</div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    po::notify(vm);</div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    <span class="keywordflow">if</span> (vm.count(<span class="stringliteral">&quot;help&quot;</span>) || vm.count(<span class="stringliteral">&quot;h&quot;</span>))</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;    {</div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;      cout &lt;&lt; <span class="stringliteral">&quot;\nUnicomm based HTTP sample.\n\n&quot;</span> &lt;&lt; desc &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;</div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;      exit(EXIT_SUCCESS);</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;    }</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  } <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  {</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    cout &lt;&lt; <span class="stringliteral">&quot;\nUnicomm based HTTP sample.\n\n&quot;</span> &lt;&lt; desc &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    exit(EXIT_SUCCESS);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;  }</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;  <span class="keywordflow">return</span> vm;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;}</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;<span class="keywordtype">void</span> server_task(<a class="code" href="classunicomm_1_1dispatcher.html" title="Unicomm communicator manager class.">unicomm::dispatcher</a>&amp; s)</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;{</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  s.<a class="code" href="classunicomm_1_1dispatcher.html#a52ea99895975a2019246877bae490dac" title="Main dispatcher&#39;s loop.">run</a>();</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;}</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;<span class="keywordtype">void</span> start(<a class="code" href="classunicomm_1_1server.html" title="Unicomm server.">unicomm::server</a>&amp; s, <span class="keywordtype">size_t</span> threads_num = 1)</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;{</div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="keywordflow">if</span> (!s.<a class="code" href="classunicomm_1_1dispatcher.html#a15810d2dda7e1eec88eaa65ba8c64407" title="Whether processing started.">started</a>())</div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  {</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    s.<a class="code" href="classunicomm_1_1dispatcher.html#a562afa6317184a43604ce5f3065b0fb4" title="Initializes the dispatcher.">reset</a>();</div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;  }</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;  s.<a class="code" href="classunicomm_1_1server.html#adc926c1b0dfef739d9922a3b59dd89b1" title="Tells the underlying logic to perform one accept operation on the socket.">accept</a>();</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;  start_task(&amp;server_task, s, threads_num);</div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  stringstream ss;</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  ss &lt;&lt; s.<a class="code" href="classunicomm_1_1dispatcher.html#a34ae7ca3b57f9338b9d82c2a17b0c32e" title="Returns configuration object is held by the dispatcher.">config</a>().<a class="code" href="classunicomm_1_1config.html#a677e1127ee18ed30d261fd6d834d60cf" title="Returns endpoint to connect to or listen to.">endpoint</a>();</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;  uni_http::out_str(<span class="stringliteral">&quot;Listening on &quot;</span> + ss.str() + <span class="stringliteral">&quot; for &quot;</span> + uni_http::version());</div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;}</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;<span class="comment">// This stuff used to make process run as daemon under Unix systems</span></div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;<span class="preprocessor">#ifdef UNI_UNIX</span></div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="keywordtype">void</span> signal_handler(<span class="keywordtype">int</span> sig)</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;{</div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="keywordflow">switch</span>(sig)</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  {</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;    <span class="comment">//case SIGUSR1:</span></div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;    <span class="comment">//  UNICOMM_DEBUG_OUT(&quot;[http]: SIGUSR1 is arrived&quot;)</span></div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;    <span class="comment">//  start(server());</span></div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;    <span class="comment">//break;</span></div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;    <span class="comment">//case SIGHUP:</span></div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;    <span class="comment">//  UNICOMM_DEBUG_OUT(&quot;[http]: SIGHUP is arrived&quot;)</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;    <span class="comment">//break;</span></div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    <span class="keywordflow">case</span> SIGTERM:</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;      {</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;        UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: SIGTERM is arrived&quot;</span>)</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;        int res = EXIT_FAILURE;</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;        try</div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;        {</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;          UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Stopping services...&quot;</span>)</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;          stop(server());</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;          res = EXIT_SUCCESS;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;          UNICOMM_DEBUG_OUT(&quot;[http]: Services are successfully stopped&quot;)</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;        }</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;        catch (const std::exception&amp; e)</div>
<div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;        {</div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;          UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: An exception has occurred while stopping [&quot;</span> </div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;            &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;        }</div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;        <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;        {</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;          UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: An unknwon exception has occurred while stopping&quot;</span>)</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;        }</div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;        UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Finita&quot;</span>)</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;        exit(res);</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;      }</div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    break;</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;  }</div>
<div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;}</div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;</div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="keywordtype">bool</span> is_daemon(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;{</div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="keywordflow">return</span> getppid() == 1;</div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;}</div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;</div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="keywordtype">int</span> check_error(<span class="keywordtype">int</span> i, <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; err_message)</div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;{</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;  <span class="keywordflow">if</span> (i &lt; 0)</div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;  {</div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;    <span class="keywordflow">throw</span> runtime_error(err_message);</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  }</div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;  <span class="keywordflow">return</span> i;</div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;}</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;<span class="keywordtype">int</span> dup_fd(<span class="keywordtype">int</span> old_fd)</div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;{</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;  <span class="keywordflow">return</span> check_error(dup(old_fd), <span class="stringliteral">&quot;Couldn&#39;t dup&quot;</span>);</div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;}</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="keywordtype">void</span> setup_linux_signals(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;{</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  <span class="comment">// register signal handlers</span></div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="preprocessor">#ifndef UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;  signal(SIGCHLD, SIG_IGN); <span class="comment">// ignore child</span></div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="preprocessor">#endif // UNICOMM_FORK_SUPPORT</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  signal(SIGTSTP, SIG_IGN); <span class="comment">// ignore tty signals</span></div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  signal(SIGTTOU, SIG_IGN);</div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  signal(SIGTTIN, SIG_IGN);</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  signal(SIGHUP, &amp;signal_handler); <span class="comment">// catch hangup signal</span></div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  signal(SIGTERM, &amp;signal_handler); <span class="comment">// catch term signal</span></div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  signal(SIGUSR1, &amp;signal_handler); <span class="comment">// catch usr1 signal</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;}</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;</div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="comment">//-------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="keyword">typedef</span> std::pair&lt;bool, int&gt; daemonize_result_type;</div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="comment">//-------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="keywordtype">bool</span> is_daemonize_error(<span class="keyword">const</span> daemonize_result_type&amp; res)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;{</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  <span class="keywordflow">return</span> res.second == 0;</div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;}</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;</div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="keywordtype">bool</span> is_child_process(<span class="keyword">const</span> daemonize_result_type&amp; res)</div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;{</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="keywordflow">return</span> res.first;</div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;}</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="keywordtype">bool</span> is_parent_process(<span class="keyword">const</span> daemonize_result_type&amp; res)</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;{</div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;  <span class="keywordflow">return</span> !is_child_process(res);</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;}</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;</div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">//------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;daemonize_result_type daemonize(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;{</div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;  <span class="comment">// create child process</span></div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;  <span class="keywordtype">int</span> i = fork();</div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;  <span class="comment">// check fork error</span></div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;  check_error(i, <span class="stringliteral">&quot;Couldn&#39;t fork&quot;</span>);</div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="comment">// parent returns</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;  <span class="keywordflow">if</span> (i &gt; 0)</div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;  {</div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Parent: fork succeeded&quot;</span>)</div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;    return daemonize_result_type(false, i);</div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;  }</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;  <span class="comment">// child (daemon) continues</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;  UNICOMM_DEBUG_OUT(&quot;[http]: Child: fork succeeded&quot;)</div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;  <span class="comment">// obtain a new process group</span></div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;  check_error(setsid(), &quot;Couldn&#39;t setsid&quot;);</div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;  for (<span class="keywordtype">int</span> i = getdtablesize(); i &gt;= 0; --i)</div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  {</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;    <span class="comment">// close all descriptors</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    close(i);</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;  }</div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  <span class="comment">// handle standart I/O</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;  check_error(open(<span class="stringliteral">&quot;/dev/null&quot;</span>, O_RDWR), <span class="stringliteral">&quot;Couldn&#39;t open [/dev/null]&quot;</span>);</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  dup_fd(i); dup_fd(i);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;  <span class="comment">// set newly created file permissions</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;  umask(027);</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;</div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;  <span class="comment">//const string running_dir = &quot;/tmp&quot;;</span></div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;  <span class="comment">// change running directory</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  <span class="comment">//check_error(chdir(running_dir.c_str()), </span></div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  <span class="comment">//  &quot;Couldn&#39;t change process current directory to [&quot; + running_dir + &quot;]&quot;);</span></div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;  <span class="comment">// lock file - commented</span></div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;  UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Child: start locking file...&quot;</span>)</div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;  const <span class="keywordtype">string</span> lock_file   = &quot;/tmp/uni_http.lock&quot;;</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;  i = check_error(open(lock_file.c_str(), O_RDWR | O_CREAT | O_TRUNC, 0640), </div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;    &quot;Couldn&#39;t open lock file [&quot; + lock_file + &quot;]&quot;);</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  UNICOMM_DEBUG_OUT(&quot;[http]: Child: lock file is opened successfully [&quot; </div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;    &lt;&lt; lock_file &lt;&lt; &quot;]&quot;)</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;  <span class="comment">// try to lock</span></div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;  check_error(lockf(i, F_TLOCK, 0), &quot;Couldn&#39;t set lock to the file [&quot; + </div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;    lock_file + &quot;]&quot;);</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;  UNICOMM_DEBUG_OUT(&quot;[http]: Child: lock file is successfully captured [&quot; </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;    &lt;&lt; lock_file &lt;&lt; &quot;]&quot;)</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;  <span class="comment">// first instance continues</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  stringstream ss;</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;  const <span class="keywordtype">int</span> child_pid = getpid();</div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  ss &lt;&lt; child_pid;</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;  const <span class="keywordtype">string</span> s = ss.str();</div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;  <span class="comment">// write pid to lockfile</span></div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;  check_error(write(i, s.c_str(), s.size()), &quot;Couldn&#39;t write lock file [&quot; + </div>
<div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;    lock_file + &quot;]&quot;);</div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;</div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;  <span class="comment">// register signal handlers</span></div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;  setup_linux_signals();</div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;  return daemonize_result_type(true, child_pid);</div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;}</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;<span class="comment"> *  *getch*()  --  a blocking single character input from stdin</span></div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment"> *  Returns a character, or -1 if an input error occurs.</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;<span class="comment"> *  Conditionals allow compiling with or without echoing of</span></div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="comment"> *  the input characters, and with or without flushing pre-existing</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;<span class="comment"> *  existing  buffered input before blocking.</span></div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="keywordtype">int</span> getch(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;{</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  <span class="keywordtype">char</span>                  ch;</div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <span class="keywordtype">int</span>                   error;</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  <span class="keyword">static</span> <span class="keyword">struct </span>termios Otty, Ntty;</div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  fflush(stdout);</div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  tcgetattr(0, &amp;Otty);</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;  Ntty = Otty;</div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;  Ntty.c_iflag  =  0;           <span class="comment">/* input mode           */</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  Ntty.c_oflag  =  0;           <span class="comment">/* output mode          */</span></div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  Ntty.c_lflag &amp;= ~ICANON;  <span class="comment">/* line settings        */</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;<span class="preprocessor">#if 1</span></div>
<div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;<span class="preprocessor"></span>  <span class="comment">/* disable echoing the char as it is typed */</span></div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;  Ntty.c_lflag &amp;= ~ECHO;    <span class="comment">/* disable echo         */</span></div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="preprocessor"></span>  <span class="comment">/* enable echoing the char as it is typed */</span></div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;  Ntty.c_lflag |=  ECHO;        <span class="comment">/* enable echo          */</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  Ntty.c_cc[VMIN]  = CMIN;      <span class="comment">/* minimum time to wait */</span></div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  Ntty.c_cc[VTIME] = CTIME;     <span class="comment">/* minimum chars to wait for */</span></div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;<span class="preprocessor">#if 1</span></div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;<span class="preprocessor"></span><span class="comment">/*</span></div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment"> * use this to flush the input buffer before blocking for new input</span></div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;<span class="preprocessor">#define FLAG TCSAFLUSH</span></div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#else</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;<span class="preprocessor"></span><span class="comment">/*</span></div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="comment"> * use this to return a char from the current input buffer, or block if</span></div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="comment"> * no input is waiting.</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;<span class="preprocessor">#define FLAG TCSANOW</span></div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160; <span class="keywordflow">if</span> (0 == (error = tcsetattr(0, FLAG, &amp;Ntty))) {</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;    error  = read(0, &amp;ch, 1 );                <span class="comment">/* get char from stdin */</span></div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;    error += tcsetattr(0, FLAG, &amp;Otty);   <span class="comment">/* restore old settings */</span></div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  }</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="keywordflow">return</span> (error == 1 ? (<span class="keywordtype">int</span>) ch : -1 );</div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;}</div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;<span class="comment">//-------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;<span class="keyword">inline</span> <span class="keywordtype">int</span> _getch(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;{</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  <span class="keywordflow">return</span> getch();</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;}</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;<span class="comment">//-------------------------------------------------------------------------</span></div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;daemonize_result_type become_daemon(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;{</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;  daemonize_result_type res(<span class="keyword">false</span>, 0);</div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;  <span class="comment">// is already a daemon</span></div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;  <span class="keywordflow">if</span> (!is_daemon())</div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;  {</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;    <span class="keywordflow">try</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;    {</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;      UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Trying to become a daemon...&quot;</span>)</div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;      res = daemonize();</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    }</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;    catch (const std::exception&amp; e)</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;    {</div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;      cout &lt;&lt; <span class="stringliteral">&quot;[http]: An std::exception occurred [&quot;</span> &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>;</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;</div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;      UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: An error [&quot;</span> &lt;&lt; e.what() &lt;&lt; <span class="stringliteral">&quot;]&quot;</span>)</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;    }</div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;    <span class="keywordflow">catch</span> (...)</div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;    {</div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;      cout &lt;&lt; <span class="stringliteral">&quot;[http]: An UNKNOWN exception occurred; pid = &quot;</span> &lt;&lt; res.second;</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;      UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Unknown error at startup; pid = &quot;</span> &lt;&lt; res.second)</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;    }</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  } <span class="keywordflow">else</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  {</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;    cout &lt;&lt; <span class="stringliteral">&quot;[http]: Already a daemon&quot;</span>;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;</div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;    UNICOMM_DEBUG_OUT(<span class="stringliteral">&quot;[http]: Already a daemon&quot;</span>)</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  }</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;}</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;<span class="preprocessor">#endif // defined (UNI_UNIX)</span></div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;</div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;} <span class="comment">// unnamed namespace</span></div>
</div><!-- fragment --><p><a class="el" href="http_example_page.html">Back</a> </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Jun 1 2013 01:38:54 by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.2 </li>
  </ul>
</div>
</body>
</html>
